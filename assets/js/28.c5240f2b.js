(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{308:function(a,s,t){"use strict";t.r(s);var e=t(14),n=Object(e.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"t-io-框架与java8-aio-假死问题排查"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#t-io-框架与java8-aio-假死问题排查"}},[a._v("#")]),a._v(" t-io 框架与java8 AIO 假死问题排查")]),a._v(" "),s("h2",{attrs:{id:"场景介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#场景介绍"}},[a._v("#")]),a._v(" 场景介绍")]),a._v(" "),s("p",[a._v("近期我司需要根据t-io框架开发一个在线客服聊天系统，刚好t-io作者有一个商业产品谭聊，于是就开始部署测试遇到了这个假死问题。\n这个问题表现为：")]),a._v(" "),s("ol",[s("li",[a._v("http api端口假死，服务器本机curl + telnet 都连接不上，tcp连接正常建立，t-io应用不会去accept")]),a._v(" "),s("li",[a._v("IM socket + websocket端口正常使用\n目前问题已暂时解决(没根治)，特此记录下来一个持续两天的排查流程，从应用、框架、网络、最终到操作系统...\n本文作者是个菜鸟，各位看到的大佬发现了问题根源的请轻喷...")])]),a._v(" "),s("h2",{attrs:{id:"环境介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#环境介绍"}},[a._v("#")]),a._v(" 环境介绍")]),a._v(" "),s("ol",[s("li",[a._v("debian 11 + openjdk 8u342")]),a._v(" "),s("li",[a._v("debian 12 + zulu open-jdk8u452")]),a._v(" "),s("li",[a._v("centos 7 + zulu open-jdk8u452\n以上三种环境问题都存在")])]),a._v(" "),s("h2",{attrs:{id:"排查流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#排查流程"}},[a._v("#")]),a._v(" 排查流程")]),a._v(" "),s("h3",{attrs:{id:"_1-jvm排查"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-jvm排查"}},[a._v("#")]),a._v(" 1. JVM排查")]),a._v(" "),s("p",[s("strong",[a._v("起初发现问题时，第一时间怀疑的是jvm出问题，例如死锁、堆栈溢出、OOM、GC异常等")]),s("br"),a._v("\n在这里使用了阿里的线上诊断工具:arthas，使用方式："),s("br"),a._v("\n启动工具")]),a._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[a._v("java "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("jar arthas"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("boot"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("jar\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h4",{attrs:{id:"_1-1-死锁"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-死锁"}},[a._v("#")]),a._v(" 1.1 死锁")]),a._v(" "),s("p",[a._v("arthas 查询阻塞线程")]),a._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[a._v("thread "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("b\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("但是由于本次排查没遇到，所以也没有输出可以分析...")]),a._v(" "),s("h4",{attrs:{id:"_1-2-oom、gc"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-oom、gc"}},[a._v("#")]),a._v(" 1.2 OOM、GC")]),a._v(" "),s("p",[a._v("arthas 查看")]),a._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[a._v("dashboard\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("可以查看到当前内存、线程、类加载信息等，看到内存占用无异常、gc次数耗时无异常")]),a._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[a._v("memory\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("可以看到内存详细信息、GC分代信息等，本次排查无异常")]),a._v(" "),s("h4",{attrs:{id:"_1-3-堆栈"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-堆栈"}},[a._v("#")]),a._v(" 1.3 堆栈")]),a._v(" "),s("p",[a._v("使用java命令保存当前堆栈")]),a._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[a._v("jps "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 查出java应用pid")]),a._v("\njstack java应用pid"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" jstack"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("txt "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" \n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("导出假死状态时堆栈信息 对比 正常状态的堆栈信息也没发现异常")]),a._v(" "),s("p",[a._v("至此，JVM方面没发现任何异常")]),a._v(" "),s("h3",{attrs:{id:"_2-t-io源码排查"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-t-io源码排查"}},[a._v("#")]),a._v(" 2. t-io源码排查")]),a._v(" "),s("p",[s("strong",[a._v("没排查出问题，不感兴趣的可以往下走了")])]),a._v(" "),s("h4",{attrs:{id:"_2-1-启动与监听流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-启动与监听流程"}},[a._v("#")]),a._v(" 2.1 启动与监听流程")]),a._v(" "),s("p",[s("strong",[a._v("应用启动")]),s("br"),a._v("\n应用配置方面的就不放出来了，直接找到入口 "),s("code",[a._v("org.tio.http.server.HttpServerStarter#start()")]),a._v(" 直接进入tioServer.start()")]),a._v(" "),s("p",[s("img",{attrs:{src:"/cannot-understand/t-io-2.1.1.png",alt:"pic"}})]),a._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[a._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("tio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")])]),a._v("TioServer")]),a._v("#start\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"/cannot-understand/t-io-2.1.2.png",alt:"pic"}}),s("br"),a._v("\n可以看到，tioServer 启动时会去取配置里的线程池，在本应用中，监听http、socket、websocket的三个端口配置的线程池是同一个。")]),a._v(" "),s("p",[a._v("这个start方法就没什么好看的了，重点就这些，可以确定的是t-io使用了JAVA AIO。")]),a._v(" "),s("h4",{attrs:{id:"_2-2-连接接受"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-连接接受"}},[a._v("#")]),a._v(" 2.2 连接接受")]),a._v(" "),s("p",[a._v("上文提到：AIO绑定端口后，会调用一次连接接收器AcceptCompletionHandler，将它注册进AIO的channel中。\n此时操作系统如果有该绑定端口的tcp连接就会去回调这个Handler。"),s("br"),a._v(" "),s("img",{attrs:{src:"/cannot-understand/t-io-2.2.1.png",alt:"pic"}}),s("br"),a._v("\n连接接收器 accept tcp连接"),s("br"),a._v(" "),s("img",{attrs:{src:"/cannot-understand/t-io-2.2.2.png",alt:"pic"}}),s("br"),a._v(" "),s("img",{attrs:{src:"/cannot-understand/t-io-2.2.3.png",alt:"pic"}}),s("br"),a._v("\n连接数据读取")]),a._v(" "),s("p",[s("strong",[a._v("后面的就是根据业务代码去获取api对应的处理方法，像SpringMVC的 Dispatch 什么那个中央处理器一样。有兴趣的可以往下走，这对本次排查无用，按下不表")])]),a._v(" "),s("h4",{attrs:{id:"_2-3-连接响应"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-连接响应"}},[a._v("#")]),a._v(" 2.3 连接响应")]),a._v(" "),s("p",[s("img",{attrs:{src:"/cannot-understand/t-io-2.2.4.png",alt:"pic"}}),s("br"),a._v(" "),s("img",{attrs:{src:"/cannot-understand/t-io-2.2.5.png",alt:"pic"}})]),a._v(" "),s("p",[s("strong",[a._v("至此t-io http连接这一块主要流程源码已经看完，可以进入下一步排查")])]),a._v(" "),s("h3",{attrs:{id:"_3-网络排查"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-网络排查"}},[a._v("#")]),a._v(" 3. 网络排查")]),a._v(" "),s("p",[a._v("查看指定端口tcp连接数量")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("netstat")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-an")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" :"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("port"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("awk")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'{print $6}'")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sort")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("uniq")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-c")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sort")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-nr")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 可以看到当前监听端口的tcp连接状态")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 我边假死的时候可以看到好几十个CLOSE_WAIT的状态")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 因此我在想，是不是这个CLOSE_WAIT导致的假死？tcp连接被用完了？")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("p",[a._v("查看指定端口是否在监听")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[a._v("ss "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-lnt")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" :"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("port"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 这个命令可以看到本机监听的tcp端口")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# LISTEN 0 50 ")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 监听状态 50=backlog最大数量，上文提到t-io创建时是使用0，jdk默认使用50")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 我就想，是不是这个backlog的问题？导致连接不上？")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br")])]),s("p",[a._v("查看指定端口是否有tcp连接")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[a._v("tcpdump "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-i")]),a._v(" any tcp port "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("port"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 可以查看本机所有网卡上指定端口有没有tcp流量")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 排查发现一切正常，有正常握手挥手")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p",[s("strong",[a._v("tcp有正常握手挥手，我觉得所以可以排除网络问题了")])]),a._v(" "),s("h3",{attrs:{id:"_4-t-io应用与操作系统排查"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-t-io应用与操作系统排查"}},[a._v("#")]),a._v(" 4. t-io应用与操作系统排查")]),a._v(" "),s("p",[a._v("在上文，我们看了t-io的连接源码，接下来可以用arthas去排查t-io的调用堆栈，看看问题是出在了接受、读取、处理、响应之中的哪一个步骤。"),s("br"),a._v(" "),s("strong",[a._v("以下命令都是在arthas中进行调用")])]),a._v(" "),s("h4",{attrs:{id:"检查连接接收器acceptcompletionhandler有没有正常调用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#检查连接接收器acceptcompletionhandler有没有正常调用"}},[a._v("#")]),a._v(" 检查连接接收器AcceptCompletionHandler有没有正常调用")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" org.tio.server.AcceptCompletionHandler completed "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"{params,throwExp}"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-x")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-n")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 监听 AcceptCompletionHandler的completed方法有没有被调用，打印 params：传入参数、throwExp：有没有抛出异常 、 -x：对象展开深度 -n：匹配n次后退出")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("h4",{attrs:{id:"检查连接读取器readcompletionhandler有没有正常调用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#检查连接读取器readcompletionhandler有没有正常调用"}},[a._v("#")]),a._v(" 检查连接读取器ReadCompletionHandler有没有正常调用")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" org.tio.server.ReadCompletionHandler completed "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"{params,throwExp}"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-x")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-n")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 监听 ReadCompletionHandler的completed方法有没有被调用，打印 params：传入参数、throwExp：有没有抛出异常 、 -x：对象展开深度 -n：匹配n次后退出")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("h4",{attrs:{id:"检查解码器decoderunnable有没有正常调用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#检查解码器decoderunnable有没有正常调用"}},[a._v("#")]),a._v(" 检查解码器DecodeRunnable有没有正常调用")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" org.tio.core.task.DecodeRunnable decode "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"{params,returnObject,throwExp}"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-x")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-n")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 监听 DecodeRunnable的decode方法有没有被调用，打印 params：传入参数、throwExp：有没有抛出异常 、 returnObject：返回值、 -x：对象展开深度 -n：匹配n次后退出")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("h4",{attrs:{id:"检查handler有没有正常调用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#检查handler有没有正常调用"}},[a._v("#")]),a._v(" 检查handler有没有正常调用")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" org.tio.core.task.HandlerRunnable decode  "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"{params,returnObject,throwExp}"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-x")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-n")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 监听 HandlerRunnable的handler方法有没有被调用，打印 params：传入参数、throwExp：有没有抛出异常 、 returnObject：返回值、 -x：对象展开深度 -n：匹配n次后退出")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("h4",{attrs:{id:"检查defaulthttprequesthandler有没有正常调用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#检查defaulthttprequesthandler有没有正常调用"}},[a._v("#")]),a._v(" 检查DefaultHttpRequestHandler有没有正常调用")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" org.tio.http.server.handler.DefaultHttpRequestHandler handler "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"{params,throwExp}"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-x")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-n")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h4",{attrs:{id:"检查t-io有没有正常响应"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#检查t-io有没有正常响应"}},[a._v("#")]),a._v(" 检查t-io有没有正常响应")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" org.tio.core.Tio send "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"{params,throwExp}"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-x")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-n")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h4",{attrs:{id:"检查jdk-aio-回调tio写是否正常"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#检查jdk-aio-回调tio写是否正常"}},[a._v("#")]),a._v(" 检查JDK AIO 回调tio写是否正常")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("watch")]),a._v(" org.tio.core.WriteCompletionHandler completed "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"{params,throwExp}"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-x")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-n")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[s("strong",[a._v("一顿操作猛如虎！发现直接卡在了AcceptCompletionHandler的回调上，接下来继续排查是操作系统没回调，还是t-io出了轨")])]),a._v(" "),s("h4",{attrs:{id:"使用stace监控fd有没有epoll回调"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用stace监控fd有没有epoll回调"}},[a._v("#")]),a._v(" 使用stace监控fd有没有epoll回调")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("strace")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-f")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("trace")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("epoll_ctl,epoll_wait,read "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("PID"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[s("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[a._v("2")]),a._v(">")]),s("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[a._v("&1")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("tee")]),a._v(" stace.log\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 监控指定pid上的系统事件")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#也可以先查出fd")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("lsof")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-nP")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-iTCP:6060")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-sTCP:LISTEN")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("strace")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-f")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("trace")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("epoll_ctl,epoll_wait,read "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("PID"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[s("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[a._v("2")]),a._v(">")]),s("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[a._v("&1")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'fd编号'")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("tee")]),a._v(" stace.log\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-E")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'epoll_wait.*(fd=fd编号|u32=fd编号)'")]),a._v(" strace.log \n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'u32=fd编号'")]),a._v(" strace.log\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#发现假死状态时根本没有epoll_wait 回调通知java")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#而正常状态时有: epoll_wait epoll_ctl ... EPOLLIN|EPOLLONSHOT 触发，也就是有被操作系统回调与jvm有往操作系统注册事件")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br")])]),s("h2",{attrs:{id:"解决方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[a._v("#")]),a._v(" 解决方案")]),a._v(" "),s("p",[a._v("至此，猜测是操作系统或者JDK AIO的问题？就是：")]),a._v(" "),s("ol",[s("li",[a._v("操作系统没回调")]),a._v(" "),s("li",[a._v("JDK AIO没注册")]),a._v(" "),s("li",[a._v("可能1和2都没发生，但是丢失了事件")])]),a._v(" "),s("p",[a._v("遇到这个问题我这个小菜鸟也没什么好方法了，只能写个监听线程，每3-5秒测试一次http端口是否正常连接，\n如果不能正常连接的话，就重置http的serverSocketChannel的监听状态，然后重新注册一次事件")]),a._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 通过反射修改监听状态，否则重复注册事件会报错")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 强行设置 acceptPending 为 false（反射 hack）")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Field")]),a._v(" acceptPending "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" serverSocketChannel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("getClass")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("getDeclaredField")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"acceptPending"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\nacceptPending"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("setAccessible")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\nacceptPending"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("set")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("serverSocketChannel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Field")]),a._v(" accepting "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" serverSocketChannel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("getClass")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("getDeclaredField")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"accepting"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\naccepting"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("setAccessible")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\naccepting"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("set")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("serverSocketChannel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("AtomicBoolean")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 重新注册 accept")]),a._v("\nserverSocketChannel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("accept")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("attachment"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" handler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br")])]),s("p",[a._v("至此问题解决")])])}),[],!1,null,null,null);s.default=n.exports}}]);