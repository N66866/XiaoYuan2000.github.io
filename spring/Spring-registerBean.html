<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>代理Bean注册到Spring容器 | NULL学习笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="分享各类资源、教程、工具等等">
    
    <link rel="preload" href="/assets/css/0.styles.1d50d329.css" as="style"><link rel="preload" href="/assets/js/app.2bce7a50.js" as="script"><link rel="preload" href="/assets/js/2.d4767806.js" as="script"><link rel="preload" href="/assets/js/1.98e67d61.js" as="script"><link rel="preload" href="/assets/js/52.12dfb0d7.js" as="script"><link rel="prefetch" href="/assets/js/10.bf9c2272.js"><link rel="prefetch" href="/assets/js/11.3e761738.js"><link rel="prefetch" href="/assets/js/12.25cb2e41.js"><link rel="prefetch" href="/assets/js/13.8696a8fa.js"><link rel="prefetch" href="/assets/js/14.6f479bb1.js"><link rel="prefetch" href="/assets/js/15.33db6b39.js"><link rel="prefetch" href="/assets/js/16.3689a3a5.js"><link rel="prefetch" href="/assets/js/17.ef4d8cc7.js"><link rel="prefetch" href="/assets/js/18.3256f17f.js"><link rel="prefetch" href="/assets/js/19.a45744ea.js"><link rel="prefetch" href="/assets/js/20.e4646aa0.js"><link rel="prefetch" href="/assets/js/21.388c94d1.js"><link rel="prefetch" href="/assets/js/22.dd250251.js"><link rel="prefetch" href="/assets/js/23.b02fd718.js"><link rel="prefetch" href="/assets/js/24.1f0e8e31.js"><link rel="prefetch" href="/assets/js/25.ccec2f13.js"><link rel="prefetch" href="/assets/js/26.4a2af455.js"><link rel="prefetch" href="/assets/js/27.cea6c22e.js"><link rel="prefetch" href="/assets/js/28.2266baa8.js"><link rel="prefetch" href="/assets/js/29.b042a7b5.js"><link rel="prefetch" href="/assets/js/3.c33b3aaa.js"><link rel="prefetch" href="/assets/js/30.0ae63275.js"><link rel="prefetch" href="/assets/js/31.9cf817b6.js"><link rel="prefetch" href="/assets/js/32.25b2dbf5.js"><link rel="prefetch" href="/assets/js/33.3d407d80.js"><link rel="prefetch" href="/assets/js/34.2851b38f.js"><link rel="prefetch" href="/assets/js/35.1eb9e3b6.js"><link rel="prefetch" href="/assets/js/36.3d522c17.js"><link rel="prefetch" href="/assets/js/37.ed332781.js"><link rel="prefetch" href="/assets/js/38.84d4d706.js"><link rel="prefetch" href="/assets/js/39.b34bed61.js"><link rel="prefetch" href="/assets/js/4.45665f8a.js"><link rel="prefetch" href="/assets/js/40.10d69ce0.js"><link rel="prefetch" href="/assets/js/41.3d871235.js"><link rel="prefetch" href="/assets/js/42.e34f6f20.js"><link rel="prefetch" href="/assets/js/43.77fec41a.js"><link rel="prefetch" href="/assets/js/44.aa13feb4.js"><link rel="prefetch" href="/assets/js/45.6ae8a925.js"><link rel="prefetch" href="/assets/js/46.55efa901.js"><link rel="prefetch" href="/assets/js/47.576e49ab.js"><link rel="prefetch" href="/assets/js/48.40771f40.js"><link rel="prefetch" href="/assets/js/49.24fb72e5.js"><link rel="prefetch" href="/assets/js/5.b31b942f.js"><link rel="prefetch" href="/assets/js/50.8c877377.js"><link rel="prefetch" href="/assets/js/51.61aeec3b.js"><link rel="prefetch" href="/assets/js/53.bdb2067d.js"><link rel="prefetch" href="/assets/js/54.8f5eadd1.js"><link rel="prefetch" href="/assets/js/6.4910e764.js"><link rel="prefetch" href="/assets/js/7.c5640ac7.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1d50d329.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">NULL学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://xiaoyuan.space" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NULL主页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="学习笔记" class="mobile-dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link router-link-active">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/practice/" class="nav-link">
  技术实践
</a></li><li class="dropdown-item"><!----> <a href="/cannot-understand/" class="nav-link">
  奇难杂症
</a></li><li class="dropdown-item"><!----> <a href="/middleware/" class="nav-link">
  中间件学习
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="已发布项目" class="dropdown-title"><span class="title">已发布项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="已发布项目" class="mobile-dropdown-title"><span class="title">已发布项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://short-link.xiaoyuan.space" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SaaS短链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://xiaoyuan.space" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NULL主页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="学习笔记" class="mobile-dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link router-link-active">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/practice/" class="nav-link">
  技术实践
</a></li><li class="dropdown-item"><!----> <a href="/cannot-understand/" class="nav-link">
  奇难杂症
</a></li><li class="dropdown-item"><!----> <a href="/middleware/" class="nav-link">
  中间件学习
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="已发布项目" class="dropdown-title"><span class="title">已发布项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="已发布项目" class="mobile-dropdown-title"><span class="title">已发布项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://short-link.xiaoyuan.space" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SaaS短链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Spring</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/spring/Spring-registerBean.html" aria-current="page" class="active sidebar-link">代理Bean注册到Spring容器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring/Spring-registerBean.html#定义接口" class="sidebar-link">定义接口</a></li><li class="sidebar-sub-header"><a href="/spring/Spring-registerBean.html#类代理实现-实现bean工厂" class="sidebar-link">类代理实现 &amp; 实现Bean工厂</a></li><li class="sidebar-sub-header"><a href="/spring/Spring-registerBean.html#bean注册" class="sidebar-link">Bean注册</a></li><li class="sidebar-sub-header"><a href="/spring/Spring-registerBean.html#测试验证" class="sidebar-link">测试验证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring/Spring-registerBean.html#定义-spring-config-xml" class="sidebar-link">定义 spring-config.xml</a></li><li class="sidebar-sub-header"><a href="/spring/Spring-registerBean.html#测试" class="sidebar-link">测试</a></li><li class="sidebar-sub-header"><a href="/spring/Spring-registerBean.html#测试结果" class="sidebar-link">测试结果</a></li></ul></li><li class="sidebar-sub-header"><a href="/spring/Spring-registerBean.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/spring/beanFactory&amp;factoryBean.html" class="sidebar-link">BeanFactory和FactoryBean的区别</a></li><li><a href="/spring/spring-start.html" class="sidebar-link">spring 容器的启动顺序</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="代理bean注册到spring容器"><a href="#代理bean注册到spring容器" class="header-anchor">#</a> 代理Bean注册到Spring容器</h1> <p><img src="/spring/interview-28-2-1.png" alt="pic"></p> <ul><li>关于Bean注册的技术场景，在我们日常用到的技术框架中，MyBatis 是最为常见的。通过在使用 MyBatis 时都只是定义一个接口不需要写实现类，但是这个接口却可以和配置的 SQL 语句关联，执行相应的数据库操作时可以返回对应的结果。那么这个接口与数据库的操作就用到的 Bean 的代理和注册。</li> <li>我们都知道类的调用是不能直接调用没有实现的接口的，所以需要通过代理的方式给接口生成对应的实现类。接下来再通过把代理类放到 Spring 的 FactoryBean 的实现中，最后再把这个 FactoryBean 实现类注册到 Spring 容器。那么现在你的代理类就已经被注册到 Spring 容器了，接下来就可以通过注解的方式注入到属性中。</li></ul> <p>按照这个实现方式，我们来操作一下，看看一个 Bean 的注册过程在代码中是如何实现的。</p> <h2 id="定义接口"><a href="#定义接口" class="header-anchor">#</a> 定义接口</h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IUserDao</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>先定义一个类似 DAO 的接口，基本这样的接口在使用 MyBatis 时还是非常常见的。后面我们会对这个接口做代理和注册。</li></ul> <h2 id="类代理实现-实现bean工厂"><a href="#类代理实现-实现bean工厂" class="header-anchor">#</a> 类代理实现 &amp; 实现Bean工厂</h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProxyBeanFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryBean</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">IUserDao</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         *
         * Java 本身的代理方式使用起来还是比较简单的，用法也很固定。
		 * InvocationHandler 是个接口类，它对应的实现内容就是代理对象的具体实现。
		 * 最后就是把代理交给 Proxy 创建代理对象，Proxy.newProxyInstance 
		 * 这里用了lambda表达式，只有一个需要实现的方法时可以这样写，这里是实现了invoke方法
         **/</span>
        <span class="token class-name">InvocationHandler</span> handler <span class="token operator">=</span> <span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;你被代理了 &quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">,</span> classes<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">IUserDao</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><ul><li>FactoryBean 在 spring 起到着二当家的地位，它将近有70多个小弟(实现它的接口定义)，那么它有三个方法:
<ul><li>T getObject() throws Exception: 返回bean实例对象</li> <li>Class&lt;?&gt; getObjectType(): 返回实例类类型</li> <li>boolean isSingleton(): 判断是否单例，单例会放到Spring容器中单实例缓存池中</li></ul></li> <li>在这里我们把上面使用Java代理的对象放到了 getObject() 方法中，那么现在再从 Spring 中获取到的对象，就是我们的代理对象了。</li></ul> <h2 id="bean注册"><a href="#bean注册" class="header-anchor">#</a> Bean注册</h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegisterBeanFactory</span> <span class="token keyword">implements</span> <span class="token class-name">BeanDefinitionRegistryPostProcessor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>

        <span class="token class-name">GenericBeanDefinition</span> beanDefinition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        beanDefinition<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span><span class="token class-name">ProxyBeanFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        registry<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token string">&quot;userDao&quot;</span><span class="token punctuation">,</span>beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 下面这样也可以</span>
		<span class="token comment">// BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(beanDefinition, &quot;userDao&quot;);</span>
        <span class="token comment">// BeanDefinitionReaderUtils.registerBeanDefinition(definitionHolder, registry);</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> configurableListableBeanFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
    	<span class="token comment">//创建bean后后置处理</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>在 Spring 的 Bean 管理中，所有的 Bean 最终都会被注册到类 DefaultListableBeanFactory 中，以上这部分代码主要的内容包括：</p> <ul><li>实现 BeanDefinitionRegistryPostProcessor.postProcessBeanDefinitionRegistry方法，获取 Bean 注册对象。</li> <li>定义 Bean，GenericBeanDefinition，这里主要设置了我们的代理类工厂。</li> <li>创建 Bean 定义处理类，BeanDefinitionHolder，这里需要的主要参数；定义 Bean 和名称 setBeanClass(ProxyBeanFactory.class)。</li> <li>最后将我们自己的bean注册到spring容器中去，registry.registerBeanDefinition()</li></ul> <h2 id="测试验证"><a href="#测试验证" class="header-anchor">#</a> 测试验证</h2> <h3 id="定义-spring-config-xml"><a href="#定义-spring-config-xml" class="header-anchor">#</a> 定义 spring-config.xml</h3> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>space.xiaoyuan.testSpringRegisterBean.RegisterBeanFactory<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestMybatis</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;spring-config.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IUserDao</span> userDao <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userDao&quot;</span><span class="token punctuation">,</span> <span class="token class-name">IUserDao</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> res <span class="token operator">=</span> userDao<span class="token punctuation">.</span><span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="测试结果"><a href="#测试结果" class="header-anchor">#</a> 测试结果</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">13</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">26.097</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">DEBUG</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>ClassPathXmlApplicationContext</span> <span class="token operator">-</span> <span class="token class-name">Refreshing</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>ClassPathXmlApplicationContext</span><span class="token annotation punctuation">@1b701da1</span>
<span class="token number">13</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">26.217</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">DEBUG</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>xml<span class="token punctuation">.</span></span>XmlBeanDefinitionReader</span> <span class="token operator">-</span> <span class="token class-name">Loaded</span> <span class="token number">1</span> bean definitions from <span class="token keyword">class</span> path resource <span class="token punctuation">[</span>spring<span class="token operator">-</span>config<span class="token punctuation">.</span>xml<span class="token punctuation">]</span>
<span class="token number">13</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">26.235</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">DEBUG</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>DefaultListableBeanFactory</span> <span class="token operator">-</span> <span class="token class-name">Creating</span> shared instance of singleton bean 'userDao'
<span class="token number">13</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">26.246</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">DEBUG</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>DefaultListableBeanFactory</span> <span class="token operator">-</span> <span class="token class-name">Overriding</span> bean definition <span class="token keyword">for</span> bean 'userDao' <span class="token keyword">with</span> <span class="token namespace">a</span> different definition<span class="token operator">:</span> replacing <span class="token punctuation">[</span><span class="token class-name">Generic</span> bean<span class="token operator">:</span> <span class="token keyword">class</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">space<span class="token punctuation">.</span>xiaoyuan<span class="token punctuation">.</span>testSpringRegisterBean<span class="token punctuation">.</span></span>RegisterBeanFactory</span><span class="token punctuation">]</span><span class="token punctuation">;</span> scope<span class="token operator">=</span><span class="token punctuation">;</span> <span class="token keyword">abstract</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span> lazyInit<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span> autowireMode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> dependencyCheck<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> autowireCandidate<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span> primary<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span> factoryBeanName<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span> factoryMethodName<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span> initMethodName<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span> destroyMethodName<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span> defined in <span class="token keyword">class</span> path resource <span class="token punctuation">[</span>spring<span class="token operator">-</span>config<span class="token punctuation">.</span>xml<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">with</span> <span class="token punctuation">[</span><span class="token class-name">Generic</span> bean<span class="token operator">:</span> <span class="token keyword">class</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">space<span class="token punctuation">.</span>xiaoyuan<span class="token punctuation">.</span>testSpringRegisterBean<span class="token punctuation">.</span></span>ProxyBeanFactory</span><span class="token punctuation">]</span><span class="token punctuation">;</span> scope<span class="token operator">=</span><span class="token punctuation">;</span> <span class="token keyword">abstract</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span> lazyInit<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span> autowireMode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> dependencyCheck<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> autowireCandidate<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span> primary<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span> factoryBeanName<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span> factoryMethodName<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span> initMethodName<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span> destroyMethodName<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">]</span>
<span class="token number">13</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">26.255</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">DEBUG</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>DefaultListableBeanFactory</span> <span class="token operator">-</span> <span class="token class-name">Creating</span> shared instance of singleton bean 'userDao'
你被代理了 queryUserInfo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>从测试结果可以看到，我们已经可以通过注入到Spring的代理Bean对象，实现我们的预期结果。</li> <li>其实这个过程也是很多框架中用到的方式，尤其是在一些中间件开发，类似的 ORM 框架都需要使用到。</li></ul> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li>本章节的内容相对来说非常并不复杂，只不过这一块的代码是我们从源码的学习中提取出来的最核心流程，因为在大部分框架中也基本都是这样的进行处理的。如果这样的地方不了解，那么很难读懂诸如此类的框架源码，也很难理解它是怎么调用的。</li> <li>在本文中主要涉及到的技术点包括；代理、对象、注册，以及相应的使用。尤其是 Bean 的定义 <code>BeanDefinitionHolder</code> 和 Bean 的注册 <code>BeanDefinitionReaderUtils.registerBeanDefinition。</code></li> <li>如果你还能把此类技术联想的更多，可以尝试把代理的对象替换成数据库的查询对象，也就是对JDBC的操作，当你完成以后也就实现了一个简单的ORM框架。其实很多技术实现都是由小做大，但最开始的那部分是整个代码实现的核心。</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/2/2024, 5:53:23 PM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/spring/beanFactory&amp;factoryBean.html">
        BeanFactory和FactoryBean的区别
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2bce7a50.js" defer></script><script src="/assets/js/2.d4767806.js" defer></script><script src="/assets/js/1.98e67d61.js" defer></script><script src="/assets/js/52.12dfb0d7.js" defer></script>
  </body>
</html>
