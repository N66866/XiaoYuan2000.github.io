<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Thread | NULL学习笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="分享各类资源、教程、工具等等">
    
    <link rel="preload" href="/assets/css/0.styles.1d50d329.css" as="style"><link rel="preload" href="/assets/js/app.ffae7823.js" as="script"><link rel="preload" href="/assets/js/2.d4767806.js" as="script"><link rel="preload" href="/assets/js/1.98e67d61.js" as="script"><link rel="preload" href="/assets/js/43.628ba3ea.js" as="script"><link rel="prefetch" href="/assets/js/10.bf9c2272.js"><link rel="prefetch" href="/assets/js/11.3e761738.js"><link rel="prefetch" href="/assets/js/12.25cb2e41.js"><link rel="prefetch" href="/assets/js/13.8696a8fa.js"><link rel="prefetch" href="/assets/js/14.6f479bb1.js"><link rel="prefetch" href="/assets/js/15.33db6b39.js"><link rel="prefetch" href="/assets/js/16.3689a3a5.js"><link rel="prefetch" href="/assets/js/17.ef4d8cc7.js"><link rel="prefetch" href="/assets/js/18.3256f17f.js"><link rel="prefetch" href="/assets/js/19.a45744ea.js"><link rel="prefetch" href="/assets/js/20.e4646aa0.js"><link rel="prefetch" href="/assets/js/21.388c94d1.js"><link rel="prefetch" href="/assets/js/22.dd250251.js"><link rel="prefetch" href="/assets/js/23.b02fd718.js"><link rel="prefetch" href="/assets/js/24.0125a3b9.js"><link rel="prefetch" href="/assets/js/25.52eedab9.js"><link rel="prefetch" href="/assets/js/26.e0fd3f63.js"><link rel="prefetch" href="/assets/js/27.7b72e9c7.js"><link rel="prefetch" href="/assets/js/28.26f3ff27.js"><link rel="prefetch" href="/assets/js/29.86c7b95d.js"><link rel="prefetch" href="/assets/js/3.c33b3aaa.js"><link rel="prefetch" href="/assets/js/30.ae4eae78.js"><link rel="prefetch" href="/assets/js/31.e8967313.js"><link rel="prefetch" href="/assets/js/32.140d2537.js"><link rel="prefetch" href="/assets/js/33.c1b529d9.js"><link rel="prefetch" href="/assets/js/34.d3756f68.js"><link rel="prefetch" href="/assets/js/35.ebcda0f9.js"><link rel="prefetch" href="/assets/js/36.c2ff92ef.js"><link rel="prefetch" href="/assets/js/37.d193157e.js"><link rel="prefetch" href="/assets/js/38.0ce824b3.js"><link rel="prefetch" href="/assets/js/39.072a689f.js"><link rel="prefetch" href="/assets/js/4.45665f8a.js"><link rel="prefetch" href="/assets/js/40.35424d53.js"><link rel="prefetch" href="/assets/js/41.624919a4.js"><link rel="prefetch" href="/assets/js/42.78d6a98b.js"><link rel="prefetch" href="/assets/js/44.5b9ce3e7.js"><link rel="prefetch" href="/assets/js/45.b54d4b9d.js"><link rel="prefetch" href="/assets/js/46.c30867a8.js"><link rel="prefetch" href="/assets/js/47.49d596af.js"><link rel="prefetch" href="/assets/js/48.fad54a6d.js"><link rel="prefetch" href="/assets/js/49.29381629.js"><link rel="prefetch" href="/assets/js/5.b31b942f.js"><link rel="prefetch" href="/assets/js/50.caa2c953.js"><link rel="prefetch" href="/assets/js/51.3ab9f292.js"><link rel="prefetch" href="/assets/js/52.be5e391c.js"><link rel="prefetch" href="/assets/js/53.73e71f5c.js"><link rel="prefetch" href="/assets/js/54.a6937051.js"><link rel="prefetch" href="/assets/js/55.009d33ca.js"><link rel="prefetch" href="/assets/js/56.017a650c.js"><link rel="prefetch" href="/assets/js/57.2e5052de.js"><link rel="prefetch" href="/assets/js/6.4910e764.js"><link rel="prefetch" href="/assets/js/7.c5640ac7.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1d50d329.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">NULL学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://xiaoyuan.space" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NULL主页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="学习笔记" class="mobile-dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/practice/" class="nav-link">
  技术实践
</a></li><li class="dropdown-item"><!----> <a href="/cannot-understand/" class="nav-link">
  奇难杂症
</a></li><li class="dropdown-item"><!----> <a href="/middleware/" class="nav-link">
  中间件学习
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="已发布项目" class="dropdown-title"><span class="title">已发布项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="已发布项目" class="mobile-dropdown-title"><span class="title">已发布项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://short-link.xiaoyuan.space" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SaaS短链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://xiaoyuan.space" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NULL主页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="学习笔记" class="mobile-dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/practice/" class="nav-link">
  技术实践
</a></li><li class="dropdown-item"><!----> <a href="/cannot-understand/" class="nav-link">
  奇难杂症
</a></li><li class="dropdown-item"><!----> <a href="/middleware/" class="nav-link">
  中间件学习
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="已发布项目" class="dropdown-title"><span class="title">已发布项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="已发布项目" class="mobile-dropdown-title"><span class="title">已发布项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://short-link.xiaoyuan.space" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SaaS短链接
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java底层</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java并发编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java多线程</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/thread.html" aria-current="page" class="active sidebar-link">Thread</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/thread.html#start-它是怎么让线程启动的呢" class="sidebar-link">start() ，它是怎么让线程启动的呢？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/thread.html#线程启动分析" class="sidebar-link">线程启动分析</a></li><li class="sidebar-sub-header"><a href="/java/thread.html#线程启动过程" class="sidebar-link">线程启动过程</a></li><li class="sidebar-sub-header"><a href="/java/thread.html#总结" class="sidebar-link">总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/java/thread.html#thread-线程-状态转换、方法使用、原理分析" class="sidebar-link">Thread 线程，状态转换、方法使用、原理分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/thread.html#thread-状态关系" class="sidebar-link">Thread 状态关系</a></li><li class="sidebar-sub-header"><a href="/java/thread.html#thread-状态测试" class="sidebar-link">Thread 状态测试</a></li><li class="sidebar-sub-header"><a href="/java/thread.html#thread-方法使用" class="sidebar-link">Thread 方法使用</a></li><li class="sidebar-sub-header"><a href="/java/thread.html#总结-2" class="sidebar-link">总结</a></li></ul></li></ul></li><li><a href="/java/ThreadPoolExecutor.html" class="sidebar-link">ThreadPoolExecutor</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="thread"><a href="#thread" class="header-anchor">#</a> Thread</h1> <h2 id="start-它是怎么让线程启动的呢"><a href="#start-它是怎么让线程启动的呢" class="header-anchor">#</a> start() ，它是怎么让线程启动的呢？</h2> <h3 id="线程启动分析"><a href="#线程启动分析" class="header-anchor">#</a> 线程启动分析</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// todo</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>咳咳，Java 的线程创建和启动非常简单，但如果问一个线程是怎么启动起来的往往并不清楚，甚至不知道为什么启动时是调用<code>start()</code>，而不是调用<code>run()</code>方法呢？</p> <p>那么，为了让大家有一个更直观的认知，我们先站在上帝视角。把这段 Java 的线程代码，到 JDK 方法使用，以及 JVM 的相应处理过程，展示给大家，以方便我们后续逐步分析。
<img src="/java/thread/interview-19-1.png" alt="pic">
以上，就是一个线程启动的整体过程分析，会涉及到如下知识点：</p> <ul><li>线程的启动会涉及到本地方法（JNI）的调用，也就是那部分 C++ 编写的代码。</li> <li>JVM 的实现中会有不同操作系统对线程的统一处理，比如：Win、Linux、Unix。</li> <li>线程的启动会涉及到线程的生命周期状态（RUNNABLE），以及唤醒操作，所以最终会有回调操作。也就是调用我们的 run() 方法</li> <li><strong>所以调用run()方法只是会在当前线程执行，而不是启动一个新线程来执行。而start()方法则会新建一个线程，再回调run()方法。</strong></li> <li>接下来，我们就开始逐步分析每一步源码的执行内容，从而了解线程启动过程。</li></ul> <h3 id="线程启动过程"><a href="#线程启动过程" class="header-anchor">#</a> 线程启动过程</h3> <h4 id="thread-start-uml-图"><a href="#thread-start-uml-图" class="header-anchor">#</a> Thread start UML 图</h4> <p><img src="/java/thread/interview-19-2.png" alt="pic"><br>
如图 19-2 是线程的启动过程时序图，整体的链路较长，会涉及到 JVM 的操作。</p> <blockquote><p>核心源码如下：<br>
Thread.c：https://github.com/unofficial-openjdk/openjdk/blob/jdk/jdk/src/java.base/share/native/libjava/Thread.c
jvm.cpp：https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/prims/jvm.cpp
thread.cpp：https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp
os.cpp：https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/os.hpp
os_linux.cpp：https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp
os_windows.cpp：https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/windows/vm/os_windows.cpp
vmSymbols.hpp：https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/classfile/vmSymbols.hpp</p></blockquote> <h4 id="java-层面-thread-启动"><a href="#java-层面-thread-启动" class="header-anchor">#</a> Java 层面 Thread 启动</h4> <h5 id="start-方法"><a href="#start-方法" class="header-anchor">#</a> start() 方法</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// todo</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// JDK 源码</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>threadStatus <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalThreadStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    group<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> started <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">start0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>started<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                group<span class="token punctuation">.</span><span class="token function">threadStartFailed</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><ul><li>线程启动方法 start()，在它的方法英文注释中已经把核心内容描述出来。Causes this thread to begin execution; the Java Virtual Machine calls the run method of this thread. 这段话的意思是：由 JVM 调用此线程的 run 方法，使线程开始执行。其实这就是一个 JVM 的回调过程，下文源码分析中会讲到</li> <li>另外 start() 是一个 synchronized 方法，但为了避免多次调用，在方法中会由线程状态判断。threadStatus != 0。</li> <li>group.add(this)，是把当前线程加入到线程组，ThreadGroup。</li> <li>start0()，是一个本地方法，通过 JNI 方式调用执行。这一步的操作才是启动线程的核心步骤。</li></ul> <hr> <h5 id="start0-本地方法"><a href="#start0-本地方法" class="header-anchor">#</a> start0() 本地方法</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 本地方法 start0</span>
<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">start0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注册本地方法</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token comment">/* Make sure registerNatives is the first thing &lt;clinit&gt; does. */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">registerNatives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token function">registerNatives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>    
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li><code>start0()</code>，是一个本地方法，用于启动线程。</li> <li><code>registerNatives()</code>，这个方法是用于注册线程执行过程中需要的一些本地方法，比如：start0、isAlive、yield、sleep、interrupt0等。</li></ul> <p>registerNatives，本地方法定义在 Thread.c 中，以下是定义的核心源码：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> JNINativeMethod methods<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span><span class="token string">&quot;start0&quot;</span><span class="token punctuation">,</span>           <span class="token string">&quot;()V&quot;</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>JVM_StartThread<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;stop0&quot;</span><span class="token punctuation">,</span>            <span class="token string">&quot;(&quot;</span> OBJ <span class="token string">&quot;)V&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>JVM_StopThread<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;isAlive&quot;</span><span class="token punctuation">,</span>          <span class="token string">&quot;()Z&quot;</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>JVM_IsThreadAlive<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;suspend0&quot;</span><span class="token punctuation">,</span>         <span class="token string">&quot;()V&quot;</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>JVM_SuspendThread<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;resume0&quot;</span><span class="token punctuation">,</span>          <span class="token string">&quot;()V&quot;</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>JVM_ResumeThread<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;setPriority0&quot;</span><span class="token punctuation">,</span>     <span class="token string">&quot;(I)V&quot;</span><span class="token punctuation">,</span>       <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>JVM_SetThreadPriority<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;yield&quot;</span><span class="token punctuation">,</span>            <span class="token string">&quot;()V&quot;</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>JVM_Yield<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;sleep&quot;</span><span class="token punctuation">,</span>            <span class="token string">&quot;(J)V&quot;</span><span class="token punctuation">,</span>       <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>JVM_Sleep<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;currentThread&quot;</span><span class="token punctuation">,</span>    <span class="token string">&quot;()&quot;</span> THD<span class="token punctuation">,</span>     <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>JVM_CurrentThread<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;interrupt0&quot;</span><span class="token punctuation">,</span>       <span class="token string">&quot;()V&quot;</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>JVM_Interrupt<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;holdsLock&quot;</span><span class="token punctuation">,</span>        <span class="token string">&quot;(&quot;</span> OBJ <span class="token string">&quot;)Z&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>JVM_HoldsLock<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;getThreads&quot;</span><span class="token punctuation">,</span>        <span class="token string">&quot;()[&quot;</span> THD<span class="token punctuation">,</span>   <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>JVM_GetAllThreads<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;dumpThreads&quot;</span><span class="token punctuation">,</span>      <span class="token string">&quot;([&quot;</span> THD <span class="token string">&quot;)[[&quot;</span> STE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>JVM_DumpThreads<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;setNativeName&quot;</span><span class="token punctuation">,</span>    <span class="token string">&quot;(&quot;</span> STR <span class="token string">&quot;)V&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>JVM_SetNativeThreadName<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li>源码：https://github.com/unofficial-openjdk/openjdk/blob/jdk/jdk/src/java.base/share/native/libjava/Thread.c</li> <li>从定义中可以看到，start0 方法会执行 &amp;JVM_StartThread 方法，最终由 JVM 层面启动线程。</li></ul> <h4 id="jvm-创建线程"><a href="#jvm-创建线程" class="header-anchor">#</a> JVM 创建线程</h4> <h5 id="jvm-startthread"><a href="#jvm-startthread" class="header-anchor">#</a> JVM_StartThread</h5> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//源码：https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/prims/jvm.cpp</span>
<span class="token function">JVM_ENTRY</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">,</span> <span class="token function">JVM_StartThread</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject jthread<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">JVMWrapper</span><span class="token punctuation">(</span><span class="token string">&quot;JVM_StartThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  JavaThread <span class="token operator">*</span>native_thread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 创建线程</span>
  native_thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">JavaThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread_entry<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 启动线程</span>
  <span class="token class-name">Thread</span><span class="token double-colon punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span>native_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

JVM_END
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>这部分代码比较多，但核心内容主要是创建线程和启动线程，另外 &amp;thread_entry 也是一个方法，如下：
thread_entry，线程入口</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">thread_entry</span><span class="token punctuation">(</span>JavaThread<span class="token operator">*</span> thread<span class="token punctuation">,</span> TRAPS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  HandleMark <span class="token function">hm</span><span class="token punctuation">(</span>THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Handle <span class="token function">obj</span><span class="token punctuation">(</span>THREAD<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span><span class="token function">threadObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  JavaValue <span class="token function">result</span><span class="token punctuation">(</span>T_VOID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">JavaCalls</span><span class="token double-colon punctuation">::</span><span class="token function">call_virtual</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>result<span class="token punctuation">,</span>
                          obj<span class="token punctuation">,</span>
                          <span class="token function">KlassHandle</span><span class="token punctuation">(</span>THREAD<span class="token punctuation">,</span> <span class="token class-name">SystemDictionary</span><span class="token double-colon punctuation">::</span><span class="token function">Thread_klass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                          vmSymbols<span class="token double-colon punctuation">::</span><span class="token function">run_method_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                          vmSymbols<span class="token double-colon punctuation">::</span><span class="token function">void_method_signature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                          THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>重点，在创建线程引入这个线程入口的方法时，thread_entry 中包括了 Java 的回调函数 JavaCalls::call_virtual。这个回调函数会由 JVM 调用。
vmSymbols::run_method_name()，就是那个被回调的方法，源码如下：</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//源码：https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/classfile/vmSymbols.hpp</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">VM_SYMBOLS_DO</span><span class="token expression"><span class="token punctuation">(</span><span class="token keyword">template</span><span class="token punctuation">,</span> do_alias<span class="token punctuation">)</span></span></span>
<span class="token keyword">template</span><span class="token punctuation">(</span>run_method_name<span class="token punctuation">,</span> <span class="token string">&quot;run&quot;</span><span class="token punctuation">)</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>这个 run 就是我们的 Java 程序中会被调用的 run 方法。接下来我们继续按照代码执行链路，寻找到这个被回调的方法在什么时候调用的。</li></ul> <hr> <h5 id="javathread"><a href="#javathread" class="header-anchor">#</a> JavaThread</h5> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>native_thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">JavaThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread_entry<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接下来，我们继续看 <code>JavaThread</code> 的源码执行内容。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//源码：https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp</span>
<span class="token class-name">JavaThread</span><span class="token double-colon punctuation">::</span><span class="token function">JavaThread</span><span class="token punctuation">(</span>ThreadFunction entry_point<span class="token punctuation">,</span> size_t stack_sz<span class="token punctuation">)</span> <span class="token operator">:</span>
  <span class="token function">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">INCLUDE_ALL_GCS</span></span>
  <span class="token punctuation">,</span> <span class="token function">_satb_mark_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_satb_mark_queue_set<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">_dirty_card_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_dirty_card_queue_set<span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// INCLUDE_ALL_GCS</span></span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TraceThreadEvents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tty<span class="token operator">-&gt;</span><span class="token function">print_cr</span><span class="token punctuation">(</span><span class="token string">&quot;creating thread %p&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  _jni_attach_state <span class="token operator">=</span> _not_attaching_via_jni<span class="token punctuation">;</span>
  <span class="token function">set_entry_point</span><span class="token punctuation">(</span>entry_point<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Create the native thread itself.</span>
  <span class="token comment">// %note runtime_23</span>
  os<span class="token double-colon punctuation">::</span>ThreadType thr_type <span class="token operator">=</span> os<span class="token double-colon punctuation">::</span>java_thread<span class="token punctuation">;</span>
  thr_type <span class="token operator">=</span> entry_point <span class="token operator">==</span> <span class="token operator">&amp;</span>compiler_thread_entry <span class="token operator">?</span> os<span class="token double-colon punctuation">::</span>compiler_thread <span class="token operator">:</span>os<span class="token double-colon punctuation">::</span>java_thread<span class="token punctuation">;</span>
  os<span class="token double-colon punctuation">::</span><span class="token function">create_thread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> thr_type<span class="token punctuation">,</span> stack_sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ul><li>ThreadFunction entry_point，就是我们上面的 thread_entry 方法。</li> <li>size_t stack_sz，表示进程中已有的线程个数。</li> <li>这两个参数，都会传递给 os::create_thread 方法，用于创建线程使用。</li></ul> <hr> <h5 id="os-create-thread"><a href="#os-create-thread" class="header-anchor">#</a> os::create_thread</h5> <ul><li>os_linux.cpp：https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp</li> <li>os_windows.cpp：https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/windows/vm/os_windows.cpp
众所周知，JVM 是个啥！，所以它的 OS 服务实现，Linux 还有 Windows 等，都会实现线程的创建逻辑。这有点像适配器模式
os_linux -&gt; os::create_thread</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span> os<span class="token double-colon punctuation">::</span><span class="token function">create_thread</span><span class="token punctuation">(</span>Thread<span class="token operator">*</span> thread<span class="token punctuation">,</span> ThreadType thr_type<span class="token punctuation">,</span> size_t stack_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span><span class="token function">osthread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;caller responsible&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Allocate the OSThread object</span>
  OSThread<span class="token operator">*</span> osthread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">OSThread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Initial state is ALLOCATED but not INITIALIZED</span>
  osthread<span class="token operator">-&gt;</span><span class="token function">set_state</span><span class="token punctuation">(</span>ALLOCATED<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  pthread_t tid<span class="token punctuation">;</span>
  <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>attr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> java_start<span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>osthread-&gt;set_state(ALLOCATED)，初始化已分配的状态，但此时并没有初始化。</li> <li>pthread_create，是类Unix操作系统（Unix、Linux、Mac OS X等）的创建线程的函数。</li> <li>java_start，重点关注类，是实际创建线程的方法。</li></ul> <hr> <h5 id="java-start"><a href="#java-start" class="header-anchor">#</a> java_start</h5> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// 源码：https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">java_start</span><span class="token punctuation">(</span>Thread <span class="token operator">*</span>thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// 线程ID</span>
  <span class="token keyword">int</span> pid <span class="token operator">=</span> os<span class="token double-colon punctuation">::</span><span class="token function">current_process_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 设置线程</span>
  <span class="token class-name">ThreadLocalStorage</span><span class="token double-colon punctuation">::</span><span class="token function">set_thread</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 设置线程状态：INITIALIZED 初始化完成</span>
  osthread<span class="token operator">-&gt;</span><span class="token function">set_state</span><span class="token punctuation">(</span>INITIALIZED<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 唤醒所有线程</span>
  sync<span class="token operator">-&gt;</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// 循环，初始化状态，则一致等待 wait</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span>osthread<span class="token operator">-&gt;</span><span class="token function">get_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> INITIALIZED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync<span class="token operator">-&gt;</span><span class="token function">wait</span><span class="token punctuation">(</span>Mutex<span class="token double-colon punctuation">::</span>_no_safepoint_check_flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

  <span class="token comment">// 等待唤醒后，执行 run 方法</span>
  thread<span class="token operator">-&gt;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><ul><li>JVM 设置线程状态，INITIALIZED 初始化完成。</li> <li><code>sync-&gt;notify_all()</code>，唤醒所有线程。</li> <li><code>osthread-&gt;get_state() == INITIALIZED</code>，while 循环等待</li> <li><code>thread-&gt;run()</code>，是等待线程唤醒后，也就是状态变更后，才能执行到。这在我们的线程执行UML图中，也有所体现</li></ul> <h4 id="jvm-启动线程"><a href="#jvm-启动线程" class="header-anchor">#</a> JVM 启动线程</h4> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">JVM_ENTRY</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">,</span> <span class="token function">JVM_StartThread</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject jthread<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">JVMWrapper</span><span class="token punctuation">(</span><span class="token string">&quot;JVM_StartThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  JavaThread <span class="token operator">*</span>native_thread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 创建线程</span>
  native_thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">JavaThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread_entry<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 启动线程</span>
  <span class="token class-name">Thread</span><span class="token double-colon punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span>native_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

JVM_END
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>JVM_StartThread 中有两步，创建（new JavaThread）、启动（Thread::start）。创建的过程聊完了，接下来我们聊启动。</li></ul> <h5 id="thread-start"><a href="#thread-start" class="header-anchor">#</a> Thread::start</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//源码：https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp</span>
<span class="token keyword">void</span> <span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token operator">*</span> thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">DisableStartThread</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span><span class="token function">is_Java_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      java_lang_Thread<span class="token operator">::</span><span class="token function">set_thread_status</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JavaThread</span><span class="token operator">*</span><span class="token punctuation">)</span>thread<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">threadObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                          java_lang_Thread<span class="token operator">::</span><span class="token constant">RUNNABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 不同的 OS 会有不同的启动代码逻辑</span>
    os<span class="token operator">::</span><span class="token function">start_thread</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>如果没有禁用线程 DisableStartThread 并且是 Java 线程 thread-&gt;is_Java_thread()，那么设置线程状态为 RUNNABLE。</li> <li>os::start_thread(thread)，调用线程启动方法。不同的 OS 会有不同的启动代码逻辑</li></ul> <hr> <h5 id="os-start-thread-thread"><a href="#os-start-thread-thread" class="header-anchor">#</a> os::start_thread(thread)</h5> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//源码：https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/os.hpp</span>
<span class="token keyword">void</span> os<span class="token double-colon punctuation">::</span><span class="token function">start_thread</span><span class="token punctuation">(</span>Thread<span class="token operator">*</span> thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// guard suspend/resume</span>
  MutexLockerEx <span class="token function">ml</span><span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span><span class="token function">SR_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Mutex<span class="token double-colon punctuation">::</span>_no_safepoint_check_flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  OSThread<span class="token operator">*</span> osthread <span class="token operator">=</span> thread<span class="token operator">-&gt;</span><span class="token function">osthread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  osthread<span class="token operator">-&gt;</span><span class="token function">set_state</span><span class="token punctuation">(</span>RUNNABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pd_start_thread</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>osthread-&gt;set_state(RUNNABLE)，设置线程状态 RUNNABLE</li> <li>pd_start_thread(thread)，启动线程，这个就由各个 OS 实现类，实现各自系统的启动方法了。比如，windows系统和Linux系统的代码是完全不同的。</li></ul> <hr> <h5 id="pd-start-thread-thread"><a href="#pd-start-thread-thread" class="header-anchor">#</a> pd_start_thread(thread)</h5> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// 源码：https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/os/linux/vm/os_linux.cpp</span>
<span class="token keyword">void</span> os<span class="token double-colon punctuation">::</span><span class="token function">pd_start_thread</span><span class="token punctuation">(</span>Thread<span class="token operator">*</span> thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  OSThread <span class="token operator">*</span> osthread <span class="token operator">=</span> thread<span class="token operator">-&gt;</span><span class="token function">osthread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>osthread<span class="token operator">-&gt;</span><span class="token function">get_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> INITIALIZED<span class="token punctuation">,</span> <span class="token string">&quot;just checking&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Monitor<span class="token operator">*</span> sync_with_child <span class="token operator">=</span> osthread<span class="token operator">-&gt;</span><span class="token function">startThread_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  MutexLockerEx <span class="token function">ml</span><span class="token punctuation">(</span>sync_with_child<span class="token punctuation">,</span> Mutex<span class="token double-colon punctuation">::</span>_no_safepoint_check_flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  sync_with_child<span class="token operator">-&gt;</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>这部分代码 notify() 最关键，它可以唤醒线程。</li> <li>线程唤醒后，java_start 中的 thread-&gt;run(); 就可以继续执行了。</li></ul> <hr> <h4 id="jvm-线程回调"><a href="#jvm-线程回调" class="header-anchor">#</a> JVM 线程回调</h4> <h5 id="thread-run-javathread-run"><a href="#thread-run-javathread-run" class="header-anchor">#</a> thread-&gt;run()[JavaThread::run()]</h5> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// 源码：https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp</span>
<span class="token comment">// The first routine called by a new Java thread</span>
<span class="token keyword">void</span> <span class="token class-name">JavaThread</span><span class="token double-colon punctuation">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... 初始化线程操作</span>
  
  <span class="token function">thread_main_inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>os_linux.cpp 类中的 java_start 里的 thread-&gt;run()，最终调用的就是 thread.cpp 的 JavaThread::run() 方法。</li> <li>这部分还需要继续往下看，thread_main_inner(); 方法。</li></ul> <hr> <h5 id="thread-main-inner"><a href="#thread-main-inner" class="header-anchor">#</a> thread_main_inner</h5> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//源码：https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp</span>
<span class="token keyword">void</span> <span class="token class-name">JavaThread</span><span class="token double-colon punctuation">::</span><span class="token function">thread_main_inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">has_pending_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>java_lang_Thread<span class="token double-colon punctuation">::</span><span class="token function">is_stillborn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">threadObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span>
      ResourceMark <span class="token function">rm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">set_native_thread_name</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">get_thread_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    HandleMark <span class="token function">hm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">entry_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">DTRACE_THREAD_PROBE</span><span class="token punctuation">(</span>stop<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ul><li>这里有你熟悉的设置的线程名称，this-&gt;set_native_thread_name(this-&gt;get_thread_name())。</li> <li>this-&gt;entry_point()，实际调用的就是 3.1 中的 thread_entry 方法。</li> <li>thread_entry，方法最终会调用到 JavaCalls::call_virtual 里的vmSymbols::run_method_name()。也就是 run() 方法，至此线程启动完成。终于串回来了！</li></ul> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <ul><li>线程的启动过程涉及到了 JVM 的参与，所以如果没有认真了解过，确实很难从一个本地方法了解的如此透彻。</li> <li>整个源码分析可以结合着代码调用UML时序图进行学习，基本核心过程包括：<code>Java 创建线程和启动</code>、<code>调用本地方法 start0()</code>、JVM 中 <code>JVM_StartThread 的创建和启动</code>、<code>设置线程状态等待被唤醒</code>、<code>根据不同的OS启动线程并唤醒</code>、<code>最后回调 run()</code> 方法启动 Java 线程。</li> <li>有时候可能只是一步很简单的方法，也会有它的深入之处，当真的懂了以后，就不用死记硬背。</li></ul> <h2 id="thread-线程-状态转换、方法使用、原理分析"><a href="#thread-线程-状态转换、方法使用、原理分析" class="header-anchor">#</a> Thread 线程，状态转换、方法使用、原理分析</h2> <h3 id="thread-状态关系"><a href="#thread-状态关系" class="header-anchor">#</a> Thread 状态关系</h3> <p>Java 的线程状态描述在枚举类 java.lang.Thread.State 中，共包括细分如下六种状态：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    <span class="token constant">NEW</span><span class="token punctuation">,</span> <span class="token constant">RUNNABLE</span><span class="token punctuation">,</span> <span class="token constant">BLOCKED</span><span class="token punctuation">,</span> <span class="token constant">WAITING</span><span class="token punctuation">,</span> <span class="token constant">TIMED_WAITING</span><span class="token punctuation">,</span> <span class="token constant">TERMINATED</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这五种状态描述了一个线程的生命周期，其实这种状态码的定义在我们日常的业务开发中，也经常出现。比如：一个活动的提交、审核、拒绝、修改、通过、运行、关闭等，是类似的。那么线程的状态是通过下图的方式进行流转的，如图.<br> <img src="/java/thread/interview-20-1.png" alt="pic"></p> <ul><li><code>New</code>：新创建的一个线程，处于等待状态。</li> <li><code>Runnable</code>：可运行状态，并不是已经运行，具体的线程调度各操作系统决定。<strong>在 Runnable 中包含了 Ready、Running 两个状态</strong>，当线程调用了 start() 方法后，线程则处于就绪 Ready 状态，等待操作系统分配 CPU 时间片，分配后则进入 Running 运行状态。此外当调用 yield() 方法后，只是谦让的允许当前线程让出CPU，<strong>但具体让不让不一定，由操作系统决定</strong>。如果让了，那么当前线程则会处于 Ready 状态继续竞争CPU，直至执行。</li> <li><code>Timed_waiting</code>：指定时间内让出CPU资源，此时线程不会被执行，也不会被系统调度，直到等待时间到期后才会被执行。下列方法都可以触发：<code>Thread.sleep</code>、<code>Object.wait</code>、<code>Thread.join</code>、<code>LockSupport.parkNanos</code>、<code>LockSupport.parkUntil</code>。</li> <li><code>Wating</code>：可被唤醒的等待状态，此时线程不会被执行也不会被系统调度。此状态可以通过 <code>synchronized</code> 获得锁，调用 wait 方法进入等待状态。最后通过 notify、notifyall 唤醒。下列方法都可以触发：<code>Object.wait</code>、<code>Thread.join</code>、<code>LockSupport.park</code>。</li> <li><code>Blocked</code>：当发生锁竞争状态下，没有获得锁的线程会处于挂起状态。例如 synchronized 锁，先获得的先执行，没有获得的进入阻塞状态。</li> <li><code>Terminated</code>：这个是终止状态，从 New 到 Terminated 是不可逆的。一般是程序流程正常结束或者发生了异常。
这里参考枚举<code>State</code> 类的英文注释了解了每一个状态码的含义，接下来我们去尝试操作线程方法，把这些状态体现出来。</li></ul> <hr> <h3 id="thread-状态测试"><a href="#thread-状态测试" class="header-anchor">#</a> Thread 状态测试</h3> <h4 id="new"><a href="#new" class="header-anchor">#</a> NEW</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// NEW</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>这个状态很简单，就是线程创建还没有启动时就是这个状态。</li></ul> <hr> <h4 id="runnable"><a href="#runnable" class="header-anchor">#</a> RUNNABLE</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 启动</span>
thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// RUNNABLE</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>创建的线程启动后 start()，就会进入 RUNNABLE 状态。但此时并不一定在执行，而是说这个线程已经就绪，可以竞争 CPU 资源。</li></ul> <hr> <h4 id="blocked"><a href="#blocked" class="header-anchor">#</a> BLOCKED</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            obj<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// BLOCKED</span>
<span class="token comment">// BLOCKED</span>
<span class="token comment">// BLOCKED</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><ul><li>这段代码稍微有点长，主要是为了让两个线程发生锁竞争。</li> <li>第一个线程，synchronized 获取锁后休眠，不释放锁。</li> <li>第二个线程，synchronized 获取不到锁，会被挂起。</li> <li>那么最后的输出结果就会是，BLOCKED</li></ul> <hr> <h4 id="waiting"><a href="#waiting" class="header-anchor">#</a> WAITING</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            obj<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// WAITING</span>
<span class="token comment">// WAITING</span>
<span class="token comment">// WAITING</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ul><li>只要在 synchronized 代码块或者修饰的方法中，调用 wait 方法，又没有被 notify 就会进入 WAITING 状态。</li> <li>另外 Thread.join 源码中也是调用的 wait 方法，所以也会让线程进入等待状态。</li></ul> <hr> <h4 id="timed-waiting"><a href="#timed-waiting" class="header-anchor">#</a> TIMED_WAITING</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// TIMED_WAITING</span>
<span class="token comment">// TIMED_WAITING</span>
<span class="token comment">// TIMED_WAITING</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><ul><li>有了上面状态获取的对比，这个状态的获取就没什么难度了。只要改成 Thread.sleep(100000); 就可以了。</li></ul> <hr> <h4 id="terminated"><a href="#terminated" class="header-anchor">#</a> TERMINATED</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// RUNNABLE</span>
<span class="token comment">// TERMINATED</span>
<span class="token comment">// TERMINATED</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>这个就比较简单了，只要一个线程运行完，它的生命周期结束了，就进入了 TERMINATED 状态。</li></ul> <hr> <h3 id="thread-方法使用"><a href="#thread-方法使用" class="header-anchor">#</a> Thread 方法使用</h3> <h4 id="yield"><a href="#yield" class="header-anchor">#</a> yield</h4> <p>yield 方法让出CPU，但不一定让出！这种可能会用在一些同时启动的线程中，按照优先级保证重要线程的执行，也可以是其他一些特殊的业务场景（例如这个线程内容很耗时，又不那么重要，可以放在后面）。</p> <p>为了验证这个方法，我们做一个例子：启动50个线程进行，每个线程都进行1000次的加和计算。其中10个线程会执行让出CPU操作。那么，如果让出CPU那10个线程的计算加和时间都比较长，说明确实在进行让出操作。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">&gt;</span></span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Y</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> isYield<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Y</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isYield<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isYield <span class="token operator">=</span> isYield<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> l <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isYield<span class="token punctuation">)</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> atomicInteger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                count<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            atomicInteger<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            count<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> atomicInteger<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程编号：&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot; 执行完成耗时：&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> l<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; (毫秒)&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>isYield <span class="token operator">?</span> <span class="token string">&quot;让出CPU----------------------&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;不让CPU&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Y</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Y</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p><strong>测试结果</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>线程编号：<span class="token number">10</span> 执行完成耗时：<span class="token number">2</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">11</span> 执行完成耗时：<span class="token number">2</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">15</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">14</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">19</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">18</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">22</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">26</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">27</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">30</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">31</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">34</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">12</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">16</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">13</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">17</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">20</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">23</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">21</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">25</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">24</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">28</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">38</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">39</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">37</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">40</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">44</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">36</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">42</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">45</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">43</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">46</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">47</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">35</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">33</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">32</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">41</span> 执行完成耗时：<span class="token number">0</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">48</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">6</span> 执行完成耗时：<span class="token number">15</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>让出<span class="token constant">CPU</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
线程编号：<span class="token number">7</span> 执行完成耗时：<span class="token number">15</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>让出<span class="token constant">CPU</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
线程编号：<span class="token number">49</span> 执行完成耗时：<span class="token number">2</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">29</span> 执行完成耗时：<span class="token number">1</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>不让<span class="token constant">CPU</span>
线程编号：<span class="token number">2</span> 执行完成耗时：<span class="token number">17</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>让出<span class="token constant">CPU</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
线程编号：<span class="token number">1</span> 执行完成耗时：<span class="token number">11</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>让出<span class="token constant">CPU</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
线程编号：<span class="token number">4</span> 执行完成耗时：<span class="token number">15</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>让出<span class="token constant">CPU</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
线程编号：<span class="token number">8</span> 执行完成耗时：<span class="token number">12</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>让出<span class="token constant">CPU</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
线程编号：<span class="token number">5</span> 执行完成耗时：<span class="token number">12</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>让出<span class="token constant">CPU</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
线程编号：<span class="token number">9</span> 执行完成耗时：<span class="token number">12</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>让出<span class="token constant">CPU</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
线程编号：<span class="token number">0</span> 执行完成耗时：<span class="token number">21</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>让出<span class="token constant">CPU</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
线程编号：<span class="token number">3</span> 执行完成耗时：<span class="token number">21</span> <span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>让出<span class="token constant">CPU</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><ul><li>从测试结果可以看到，那些让出 CPU 的，执行完计算已经在10毫秒以上，说明我们的测试是效果的。</li></ul> <hr> <h4 id="wait-notify"><a href="#wait-notify" class="header-anchor">#</a> wait &amp; notify</h4> <p>wait 和 notify/nofityall，是一对方法，有一个等待，就会有一个叫醒，否则程序就夯在那不动了。关于这部分会使用到的 <a href="/java/synchronized#%E5%AF%B9%E8%B1%A1%E7%BB%93%E6%9E%84%E4%BB%8B%E7%BB%8D">synchronized</a> 在之前有深入的源码分析，讲到它是怎么加锁在对象头的，如果你忘记了可以翻翻看</p> <p>接下来我们模拟鹿鼎记·丽春院，清倌喝茶吟诗聊风月日常。当有达官贵人来时，需要分配清倌给大老爷。中间会有一些等待、叫醒操作。只为让你更好的记住这样的案例，不要想歪喽。清倌人即是只卖艺欢场人，喊麦的。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> 丽春院 <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        老鸨 鸨子 <span class="token operator">=</span> <span class="token keyword">new</span> 老鸨<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        清倌 miss <span class="token operator">=</span> <span class="token keyword">new</span> 清倌<span class="token punctuation">(</span>鸨子<span class="token punctuation">)</span><span class="token punctuation">;</span>
        客官 guest <span class="token operator">=</span> <span class="token keyword">new</span> 客官<span class="token punctuation">(</span>鸨子<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t_miss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>miss<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t_guest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>guest<span class="token punctuation">)</span><span class="token punctuation">;</span>

        t_miss<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t_guest<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> 清倌 <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

    老鸨 鸨子<span class="token punctuation">;</span>

    <span class="token keyword">public</span> 清倌<span class="token punctuation">(</span>老鸨 鸨子<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>鸨子 <span class="token operator">=</span> 鸨子<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e1<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    鸨子<span class="token punctuation">.</span>在岗清倌<span class="token punctuation">(</span><span class="token string">&quot;苍田野子&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;500 日元&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    鸨子<span class="token punctuation">.</span>在岗清倌<span class="token punctuation">(</span><span class="token string">&quot;花田岗子&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;800 日元&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> 客官 <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

    老鸨 鸨子<span class="token punctuation">;</span>

    <span class="token keyword">public</span> 客官<span class="token punctuation">(</span>老鸨 鸨子<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>鸨子 <span class="token operator">=</span> 鸨子<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e1<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                鸨子<span class="token punctuation">.</span>喝茶吟诗聊风月<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> 老鸨 <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> 清倌 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> price <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> 工作状态 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> 在岗清倌<span class="token punctuation">(</span><span class="token class-name">String</span> 清倌<span class="token punctuation">,</span> <span class="token class-name">String</span> price<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>工作状态<span class="token punctuation">)</span>
            <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>清倌 <span class="token operator">=</span> 清倌<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>price <span class="token operator">=</span> price<span class="token punctuation">;</span>
        工作状态 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//叫醒</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> 喝茶吟诗聊风月<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>工作状态<span class="token punctuation">)</span>
            <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;聊风月：&quot;</span> <span class="token operator">+</span> 清倌<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;茶水费：&quot;</span> <span class="token operator">+</span> price<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;  &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;  &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;  &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;  &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;  &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;  &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;  &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;  &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;  &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;  &quot;</span> <span class="token operator">+</span> 清倌 <span class="token operator">+</span> <span class="token string">&quot;完事&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;准备 ... ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;****************************************&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        工作状态 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//叫醒</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br></div></div><p><strong>测试结果</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>聊风月：苍田野子
茶水费：<span class="token number">500</span> 日元
                    苍田野子完事准备 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
聊风月：花田岗子
茶水费：<span class="token number">800</span> 日元
                    花田岗子完事准备 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
聊风月：苍田野子
茶水费：<span class="token number">500</span> 日元
                    苍田野子完事准备 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ul><li>效果效果主要体现 wait、notify，这两个方法的使用。我相信你一定能记住这个例子！</li></ul> <hr> <h4 id="join"><a href="#join" class="header-anchor">#</a> join</h4> <p>join 是两个线程的合并吗？不是的！</p> <p>join 是让线程进入 <code>wait</code> ，当线程执行完毕后，会在JVM源码中找到，它执行完毕后，其实执行<code>notify</code>，也就是 <code>等待</code> 和 <code>叫醒</code> 操作。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//源码：jdk8u_hotspot/blob/master/src/share/vm/runtime/thread.cpp</span>
<span class="token keyword">void</span> <span class="token class-name">JavaThread</span><span class="token double-colon punctuation">::</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token keyword">bool</span> destroy_vm<span class="token punctuation">,</span> ExitType exit_type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Notify waiters on thread object. This has to be done after exit() is called</span>
	<span class="token comment">// on the thread (if the thread is the last thread in a daemon ThreadGroup the</span>
	<span class="token comment">// group should have the destroyed bit set before waiters are notified).</span>
	<span class="token function">ensure_join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ensure_join</span><span class="token punctuation">(</span>JavaThread<span class="token operator">*</span> thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 叫醒</span>
  java_lang_Thread<span class="token double-colon punctuation">::</span><span class="token function">set_thread</span><span class="token punctuation">(</span><span class="token function">threadObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  lock<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>好的，就是这里！<code>lock.notify_all(thread)</code>，执行到这，就对上了。</p> <ul><li>案例：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;thread before&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;thread after&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;main begin！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;main end！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>结果：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>main begin！
thread before
thread after
main end！

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>首先join() 是一个synchronized方法， 里面调用了wait()，这个过程的目的是让持有这个同步锁的线程进入等待，那么谁持有了这个同步锁呢？答案是主线程，因为主线程调用了thread.join()方法，相当于在thread.join()代码这块写了一个同步代码块，谁去执行了这段代码呢，是主线程，所以主线程被wait()了。然后在子线程thread执行完毕之后，JVM会调用lock.notify_all(thread);唤醒持有thread这个对象锁的线程，也就是主线程，会继续执行。</p> <ul><li>这部分验证的主要体现就是加了 <code>thread.join()</code> 后，会影响到输出结果。如果不加，main end！ 会优先 thread after 提前打印出来</li> <li>join() 是一个 <code>synchronized</code> 方法，里面调用了<code>wait()</code> 方法，让持有当前同步锁的线程进入等待状态，也就是主线程。当子线程执行完毕后，我们从源码中可以看到 JVM 调用了 <code>lock.notify_all(thread)</code>所以唤醒了主线程继续执行。</li> <li>thread.join()方法会让调用它的线程（在这个例子中是主线程）阻塞，直到被调用的线程（在这个例子中是thread）执行完成或者超时。在这段代码中，主线程调用了thread.join()，因此主线程会被阻塞，直到thread线程执行完成才会继续执行后续代码。</li></ul> <hr> <h3 id="总结-2"><a href="#总结-2" class="header-anchor">#</a> 总结</h3> <ul><li>线程状态和状态的转换也是面试中必问的问题，但除了面试是我们自己在开发中，如果真的使用线程，是非常有必要了解线程状态是如何转换的。模模糊糊的使用，总会觉得担心，那么你是个好程序员！</li> <li>线程的一些深入学习都是在调用本地方法，也就是需要了解到JVM层面，才能更加深刻的见到c++代码是如何实现这部分逻辑的。</li> <li>在使用线程的时候一定要让自己有一个类似多核的脑子：线程一起、生死由你！</li> <li>本章节就扯到这了，很多的知识都是为了整套内容体系的全面，为后续介绍其他知识打下根基。感谢！</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/10/2024, 8:44:19 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/java/AQS-Share.html" class="prev">
        AQS Share Lock
      </a></span> <span class="next"><a href="/java/ThreadPoolExecutor.html">
        ThreadPoolExecutor
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ffae7823.js" defer></script><script src="/assets/js/2.d4767806.js" defer></script><script src="/assets/js/1.98e67d61.js" defer></script><script src="/assets/js/43.628ba3ea.js" defer></script>
  </body>
</html>
