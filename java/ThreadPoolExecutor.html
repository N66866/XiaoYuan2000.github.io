<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ThreadPoolExecutor | NULLå­¦ä¹ ç¬”è®°</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="åˆ†äº«å„ç±»èµ„æºã€æ•™ç¨‹ã€å·¥å…·ç­‰ç­‰">
    
    <link rel="preload" href="/assets/css/0.styles.1d50d329.css" as="style"><link rel="preload" href="/assets/js/app.43c37fe5.js" as="script"><link rel="preload" href="/assets/js/2.d4767806.js" as="script"><link rel="preload" href="/assets/js/1.98e67d61.js" as="script"><link rel="preload" href="/assets/js/36.c2ff92ef.js" as="script"><link rel="prefetch" href="/assets/js/10.bf9c2272.js"><link rel="prefetch" href="/assets/js/11.3e761738.js"><link rel="prefetch" href="/assets/js/12.25cb2e41.js"><link rel="prefetch" href="/assets/js/13.8696a8fa.js"><link rel="prefetch" href="/assets/js/14.6f479bb1.js"><link rel="prefetch" href="/assets/js/15.33db6b39.js"><link rel="prefetch" href="/assets/js/16.3689a3a5.js"><link rel="prefetch" href="/assets/js/17.ef4d8cc7.js"><link rel="prefetch" href="/assets/js/18.3256f17f.js"><link rel="prefetch" href="/assets/js/19.a45744ea.js"><link rel="prefetch" href="/assets/js/20.e4646aa0.js"><link rel="prefetch" href="/assets/js/21.388c94d1.js"><link rel="prefetch" href="/assets/js/22.dd250251.js"><link rel="prefetch" href="/assets/js/23.b02fd718.js"><link rel="prefetch" href="/assets/js/24.1f0e8e31.js"><link rel="prefetch" href="/assets/js/25.cd3911b7.js"><link rel="prefetch" href="/assets/js/26.400f6206.js"><link rel="prefetch" href="/assets/js/27.0491ea83.js"><link rel="prefetch" href="/assets/js/28.26f3ff27.js"><link rel="prefetch" href="/assets/js/29.5c541db6.js"><link rel="prefetch" href="/assets/js/3.c33b3aaa.js"><link rel="prefetch" href="/assets/js/30.5ca371a1.js"><link rel="prefetch" href="/assets/js/31.bf7431df.js"><link rel="prefetch" href="/assets/js/32.3a4396e1.js"><link rel="prefetch" href="/assets/js/33.c1b529d9.js"><link rel="prefetch" href="/assets/js/34.d3756f68.js"><link rel="prefetch" href="/assets/js/35.ebcda0f9.js"><link rel="prefetch" href="/assets/js/37.012379bc.js"><link rel="prefetch" href="/assets/js/38.4b3b381b.js"><link rel="prefetch" href="/assets/js/39.67c69bb1.js"><link rel="prefetch" href="/assets/js/4.45665f8a.js"><link rel="prefetch" href="/assets/js/40.19ac7c90.js"><link rel="prefetch" href="/assets/js/41.9a9c9e6c.js"><link rel="prefetch" href="/assets/js/42.78d6a98b.js"><link rel="prefetch" href="/assets/js/43.d603dac9.js"><link rel="prefetch" href="/assets/js/44.416ab297.js"><link rel="prefetch" href="/assets/js/45.b54d4b9d.js"><link rel="prefetch" href="/assets/js/46.17a66b8a.js"><link rel="prefetch" href="/assets/js/47.49d596af.js"><link rel="prefetch" href="/assets/js/48.452dd0fd.js"><link rel="prefetch" href="/assets/js/49.790870ba.js"><link rel="prefetch" href="/assets/js/5.b31b942f.js"><link rel="prefetch" href="/assets/js/50.caa2c953.js"><link rel="prefetch" href="/assets/js/51.18cbf11f.js"><link rel="prefetch" href="/assets/js/52.b9ffe5ac.js"><link rel="prefetch" href="/assets/js/53.3b6d385b.js"><link rel="prefetch" href="/assets/js/54.797c95a7.js"><link rel="prefetch" href="/assets/js/55.5da979d2.js"><link rel="prefetch" href="/assets/js/56.7cbcb040.js"><link rel="prefetch" href="/assets/js/57.2e5052de.js"><link rel="prefetch" href="/assets/js/6.4910e764.js"><link rel="prefetch" href="/assets/js/7.c5640ac7.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1d50d329.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">NULLå­¦ä¹ ç¬”è®°</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://xiaoyuan.space" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NULLä¸»é¡µ
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="å­¦ä¹ ç¬”è®°" class="dropdown-title"><span class="title">å­¦ä¹ ç¬”è®°</span> <span class="arrow down"></span></button> <button type="button" aria-label="å­¦ä¹ ç¬”è®°" class="mobile-dropdown-title"><span class="title">å­¦ä¹ ç¬”è®°</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/practice/" class="nav-link">
  æŠ€æœ¯å®è·µ
</a></li><li class="dropdown-item"><!----> <a href="/cannot-understand/" class="nav-link">
  å¥‡éš¾æ‚ç—‡
</a></li><li class="dropdown-item"><!----> <a href="/middleware/" class="nav-link">
  ä¸­é—´ä»¶å­¦ä¹ 
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="å·²å‘å¸ƒé¡¹ç›®" class="dropdown-title"><span class="title">å·²å‘å¸ƒé¡¹ç›®</span> <span class="arrow down"></span></button> <button type="button" aria-label="å·²å‘å¸ƒé¡¹ç›®" class="mobile-dropdown-title"><span class="title">å·²å‘å¸ƒé¡¹ç›®</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://short-link.xiaoyuan.space" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SaaSçŸ­é“¾æ¥
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://xiaoyuan.space" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NULLä¸»é¡µ
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="å­¦ä¹ ç¬”è®°" class="dropdown-title"><span class="title">å­¦ä¹ ç¬”è®°</span> <span class="arrow down"></span></button> <button type="button" aria-label="å­¦ä¹ ç¬”è®°" class="mobile-dropdown-title"><span class="title">å­¦ä¹ ç¬”è®°</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/practice/" class="nav-link">
  æŠ€æœ¯å®è·µ
</a></li><li class="dropdown-item"><!----> <a href="/cannot-understand/" class="nav-link">
  å¥‡éš¾æ‚ç—‡
</a></li><li class="dropdown-item"><!----> <a href="/middleware/" class="nav-link">
  ä¸­é—´ä»¶å­¦ä¹ 
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="å·²å‘å¸ƒé¡¹ç›®" class="dropdown-title"><span class="title">å·²å‘å¸ƒé¡¹ç›®</span> <span class="arrow down"></span></button> <button type="button" aria-label="å·²å‘å¸ƒé¡¹ç›®" class="mobile-dropdown-title"><span class="title">å·²å‘å¸ƒé¡¹ç›®</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://short-link.xiaoyuan.space" target="_blank" rel="noopener noreferrer" class="nav-link external">
  SaaSçŸ­é“¾æ¥
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Javaåº•å±‚</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Javaå¹¶å‘ç¼–ç¨‹</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Javaå¤šçº¿ç¨‹</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/thread.html" class="sidebar-link">Thread</a></li><li><a href="/java/ThreadPoolExecutor.html" aria-current="page" class="active sidebar-link">ThreadPoolExecutor</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/ThreadPoolExecutor.html#threadpoolexecutorçº¿ç¨‹æ± å®ç°åŸç†" class="sidebar-link">ThreadPoolExecutorçº¿ç¨‹æ± å®ç°åŸç†</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/ThreadPoolExecutor.html#çº¿ç¨‹æ± ä½¿ç”¨ä¾‹å­" class="sidebar-link">çº¿ç¨‹æ± ä½¿ç”¨ä¾‹å­</a></li><li class="sidebar-sub-header"><a href="/java/ThreadPoolExecutor.html#æ‰‹å†™çº¿ç¨‹æ± " class="sidebar-link">æ‰‹å†™çº¿ç¨‹æ± </a></li><li class="sidebar-sub-header"><a href="/java/ThreadPoolExecutor.html#çº¿ç¨‹æ± æºç åˆ†æ" class="sidebar-link">çº¿ç¨‹æ± æºç åˆ†æ</a></li><li class="sidebar-sub-header"><a href="/java/ThreadPoolExecutor.html#çº¿ç¨‹æ± å…³é—­" class="sidebar-link">çº¿ç¨‹æ± å…³é—­</a></li><li class="sidebar-sub-header"><a href="/java/ThreadPoolExecutor.html#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li></ul></li><li class="sidebar-sub-header"><a href="/java/ThreadPoolExecutor.html#çº¿ç¨‹æ± çš„ä»‹ç»å’Œä½¿ç”¨-ä»¥åŠåŸºäºjvmtiè®¾è®¡éå…¥ä¾µç›‘æ§" class="sidebar-link">çº¿ç¨‹æ± çš„ä»‹ç»å’Œä½¿ç”¨ï¼Œä»¥åŠåŸºäºjvmtiè®¾è®¡éå…¥ä¾µç›‘æ§</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/ThreadPoolExecutor.html#å››ç§çº¿ç¨‹æ± ä½¿ç”¨ä»‹ç»" class="sidebar-link">å››ç§çº¿ç¨‹æ± ä½¿ç”¨ä»‹ç»</a></li><li class="sidebar-sub-header"><a href="/java/ThreadPoolExecutor.html#çº¿ç¨‹æ± ä½¿ç”¨åœºæ™¯è¯´æ˜" class="sidebar-link">çº¿ç¨‹æ± ä½¿ç”¨åœºæ™¯è¯´æ˜</a></li><li class="sidebar-sub-header"><a href="/java/ThreadPoolExecutor.html#è·å–çº¿ç¨‹æ± ç›‘æ§ä¿¡æ¯" class="sidebar-link">è·å–çº¿ç¨‹æ± ç›‘æ§ä¿¡æ¯</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="threadpoolexecutor"><a href="#threadpoolexecutor" class="header-anchor">#</a> ThreadPoolExecutor</h1> <h2 id="threadpoolexecutorçº¿ç¨‹æ± å®ç°åŸç†"><a href="#threadpoolexecutorçº¿ç¨‹æ± å®ç°åŸç†" class="header-anchor">#</a> ThreadPoolExecutorçº¿ç¨‹æ± å®ç°åŸç†</h2> <h3 id="çº¿ç¨‹æ± ä½¿ç”¨ä¾‹å­"><a href="#çº¿ç¨‹æ± ä½¿ç”¨ä¾‹å­" class="header-anchor">#</a> çº¿ç¨‹æ± ä½¿ç”¨ä¾‹å­</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//æ ¸å¿ƒçº¿ç¨‹ã€æœ€å¤§çº¿ç¨‹ã€ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ã€é˜»å¡é˜Ÿåˆ—å­˜å‚¨ç­‰å¾…ä»»åŠ¡ã€‚è¿˜æœ‰ä¸ªç¬¬äº”å‚æ•°ï¼šæ‹’ç»ç­–ç•¥</span>
<span class="token class-name">ThreadPoolExecutor</span> threadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
threadPoolExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hi çº¿ç¨‹æ± ï¼&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
threadPoolExecutor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Executors.newFixedThreadPool(10);</span>
<span class="token comment">// Executors.newCachedThreadPool();</span>
<span class="token comment">// Executors.newScheduledThreadPool(10);</span>
<span class="token comment">// Executors.newSingleThreadExecutor();</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><hr> <h3 id="æ‰‹å†™çº¿ç¨‹æ± "><a href="#æ‰‹å†™çº¿ç¨‹æ± " class="header-anchor">#</a> æ‰‹å†™çº¿ç¨‹æ± </h3> <h4 id="å®ç°æµç¨‹"><a href="#å®ç°æµç¨‹" class="header-anchor">#</a> å®ç°æµç¨‹</h4> <p>å…¶å®å¾ˆå¤šæ—¶å€™ä¸€æ®µåŠŸèƒ½ä»£ç çš„æ ¸å¿ƒä¸»é€»è¾‘å¯èƒ½å¹¶æ²¡æœ‰å¤šå¤æ‚ï¼Œä½†ä¸ºäº†è®©æ ¸å¿ƒæµç¨‹é¡ºåˆ©è¿è¡Œï¼Œå°±éœ€è¦é¢å¤–æ·»åŠ å¾ˆå¤šåˆ†æ”¯çš„è¾…åŠ©æµç¨‹ã€‚å°±åƒæˆ‘å¸¸è¯´çš„ï¼Œä¸ºäº†ä¿æŠ¤æ‰‹æ‰æŠŠæ“¦å±å±çº¸å¼„é‚£ä¹ˆå¤§ï¼
<img src="/java/thread/interview-21-1.png" alt="pic">
å…³äºä¸Šå›¾ï¼Œè¿™ä¸ªæ‰‹å†™çº¿ç¨‹æ± çš„å®ç°ä¹Ÿéå¸¸ç®€å•ï¼Œåªä¼šä½“ç°å‡ºæ ¸å¿ƒæµç¨‹ï¼ŒåŒ…æ‹¬ï¼š</p> <ol><li>æœ‰nä¸ªä¸€ç›´åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œç›¸å½“äºæˆ‘ä»¬åˆ›å»ºçº¿ç¨‹æ± æ—¶å…è®¸çš„çº¿ç¨‹æ± å¤§å°ã€‚</li> <li>æŠŠçº¿ç¨‹æäº¤ç»™çº¿ç¨‹æ± è¿è¡Œã€‚</li> <li>å¦‚æœè¿è¡Œçº¿ç¨‹æ•°é‡å¤§äºç­‰äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™æŠŠçº¿ç¨‹æ”¾å…¥é˜Ÿåˆ—ä¸­ã€‚</li> <li>å¦‚æœé˜Ÿåˆ—ä¸­å®¹é‡å·²æ·»åŠ æ»¡ï¼Œåˆ™åˆ¤æ–­åˆ¤æ–­å½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦å°äºè®¾å®šçš„æœ€å¤§çº¿ç¨‹æ•°ã€‚è‹¥å°äºåˆ™çº¿ç¨‹æ± ç»§ç»­åˆ›å»ºçº¿ç¨‹æ‰§è¡Œçº¿ç¨‹ï¼Œè‹¥å¤§äºåˆ™èµ°æ‹’ç»ç­–ç•¥ã€‚</li> <li>æœ€åå½“æœ‰ç©ºé—²æ—¶ï¼Œåˆ™è·å–é˜Ÿåˆ—ä¸­çº¿ç¨‹è¿›è¡Œè¿è¡Œã€‚</li></ol> <hr> <h4 id="å®ç°ä»£ç "><a href="#å®ç°ä»£ç " class="header-anchor">#</a> å®ç°ä»£ç </h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolTrader</span> <span class="token keyword">implements</span> <span class="token class-name">Executor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> ctl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> corePoolSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ThreadPoolTrader</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>corePoolSize <span class="token operator">=</span> corePoolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maximumPoolSize <span class="token operator">=</span> maximumPoolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>workQueue <span class="token operator">=</span> workQueue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>workQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> firstTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> maximumPoolSize<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token class-name">Worker</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>firstTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        worker<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctl<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Worker</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

        <span class="token keyword">final</span> <span class="token class-name">Thread</span> thread<span class="token punctuation">;</span>
        <span class="token class-name">Runnable</span> firstTask<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> firstTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>firstTask <span class="token operator">=</span> firstTask<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Runnable</span> task <span class="token operator">=</span> firstTask<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
            	<span class="token comment">//ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶task = firstTask != null æ‰€ä»¥ä¼šå…ˆæ‰§è¡Œä¸€æ¬¡firstTå†ç»§ç»­å¾ªç¯</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>task <span class="token operator">=</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    task<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> maximumPoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    task <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                ctl<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token class-name">Runnable</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;workQueue.sizeï¼š&quot;</span> <span class="token operator">+</span> workQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> workQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Errorï¼ctl.countï¼š&quot;</span> <span class="token operator">+</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; workQueue.sizeï¼š&quot;</span> <span class="token operator">+</span> workQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadPoolTrader</span> threadPoolTrader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolTrader</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> finalI <span class="token operator">=</span> i<span class="token punctuation">;</span>
            threadPoolTrader<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ä»»åŠ¡ç¼–å·ï¼š&quot;</span> <span class="token operator">+</span> finalI<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment">// æµ‹è¯•ç»“æœ</span>

ä»»åŠ¡ç¼–å·ï¼š<span class="token number">1</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">0</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">8</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">8</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">3</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">6</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">2</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">5</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">5</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">4</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">4</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">3</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">7</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">2</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">6</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">1</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">8</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">9</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">0</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br></div></div><p>ä»¥ä¸Šï¼Œå…³äºçº¿ç¨‹æ± çš„å®ç°è¿˜æ˜¯éå¸¸ç®€å•çš„ï¼Œä»æµ‹è¯•ç»“æœä¸Šå·²ç»å¯ä»¥æŠŠæœ€æ ¸å¿ƒçš„æ± åŒ–æ€æƒ³ä½“ç°å‡ºæ¥äº†ã€‚ä¸»è¦åŠŸèƒ½é€»è¾‘åŒ…æ‹¬ï¼š</p> <ul><li>ctlï¼Œç”¨äºè®°å½•çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡ã€‚</li> <li>corePoolSizeã€maximumPoolSizeï¼Œç”¨äºé™åˆ¶çº¿ç¨‹æ± å®¹é‡ã€‚</li> <li>workQueueï¼Œçº¿ç¨‹æ± é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯é‚£äº›è¿˜ä¸èƒ½è¢«åŠæ—¶è¿è¡Œçš„çº¿ç¨‹ï¼Œä¼šè¢«è£…å…¥åˆ°è¿™ä¸ªé˜Ÿåˆ—ä¸­ã€‚</li> <li>executeï¼Œç”¨äºæäº¤çº¿ç¨‹ï¼Œè¿™ä¸ªæ˜¯é€šç”¨çš„æ¥å£æ–¹æ³•ã€‚åœ¨è¿™ä¸ªæ–¹æ³•é‡Œä¸»è¦å®ç°çš„å°±æ˜¯ï¼Œå½“å‰æäº¤çš„çº¿ç¨‹æ˜¯åŠ å…¥åˆ°workerã€é˜Ÿåˆ—è¿˜æ˜¯æ”¾å¼ƒã€‚</li> <li>addWorkerï¼Œä¸»è¦æ˜¯ç±» Worker çš„å…·ä½“æ“ä½œï¼Œåˆ›å»ºå¹¶æ‰§è¡Œçº¿ç¨‹ã€‚è¿™é‡Œè¿˜åŒ…æ‹¬äº† getTask() æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ä»é˜Ÿåˆ—ä¸­ä¸æ–­çš„è·å–æœªè¢«æ‰§è¡Œçš„çº¿ç¨‹ã€‚</li> <li>å¥½ï¼Œé‚£ä¹ˆä»¥ä¸Šå‘¢ï¼Œå°±æ˜¯è¿™ä¸ªç®€å•çº¿ç¨‹æ± å®ç°çš„å…·ä½“ä½“ç°ã€‚ä½†å¦‚æœæ·±æ€ç†Ÿè™‘å°±ä¼šå‘ç°è¿™é‡Œéœ€è¦å¾ˆå¤šå®Œå–„ï¼Œæ¯”å¦‚ï¼šçº¿ç¨‹æ± çŠ¶æ€å‘¢ï¼Œä¸å¯èƒ½ä¸€ç›´å¥”è·‘å‘€ï¼ï¼Ÿã€çº¿ç¨‹æ± çš„é”å‘¢ï¼Œä¸ä¼šæœ‰å¹¶å‘é—®é¢˜å—ï¼Ÿã€çº¿ç¨‹æ± æ‹’ç»åçš„ç­–ç•¥å‘¢ï¼Ÿï¼Œè¿™äº›é—®é¢˜éƒ½æ²¡æœ‰åœ¨ä¸»æµç¨‹è§£å†³ï¼Œä¹Ÿæ­£å› ä¸ºæ²¡æœ‰è¿™äº›æµç¨‹ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä»£ç æ‰æ›´å®¹æ˜“ç†è§£ã€‚</li></ul> <p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¼€å§‹åˆ†æçº¿ç¨‹æ± çš„æºç ï¼Œä¸æˆ‘ä»¬å®ç°çš„ç®€å•çº¿ç¨‹æ± å‚è€ƒå¯¹æ¯”ï¼Œä¼šæ›´åŠ å®¹æ˜“ç†è§£ğŸ˜„ï¼</p> <hr> <h3 id="çº¿ç¨‹æ± æºç åˆ†æ"><a href="#çº¿ç¨‹æ± æºç åˆ†æ" class="header-anchor">#</a> çº¿ç¨‹æ± æºç åˆ†æ</h3> <h4 id="çº¿ç¨‹æ± ç±»å…³ç³»å›¾"><a href="#çº¿ç¨‹æ± ç±»å…³ç³»å›¾" class="header-anchor">#</a> çº¿ç¨‹æ± ç±»å…³ç³»å›¾</h4> <p><img src="/java/thread/interview-21-2.png" alt="pic">
ä»¥å›´ç»•æ ¸å¿ƒç±» <code>ThreadPoolExecutor</code> çš„å®ç°å±•å¼€çš„ç±»ä¹‹é—´å®ç°å’Œç»§æ‰¿å…³ç³»ï¼Œå¦‚ä¸Šå›¾çº¿ç¨‹æ± ç±»å…³ç³»å›¾ã€‚</p> <ul><li>æ¥å£ <code>Executor</code>ã€<code>ExecutorService</code>ï¼Œå®šä¹‰çº¿ç¨‹æ± çš„åŸºæœ¬æ–¹æ³•ã€‚å°¤å…¶æ˜¯ <code>execute(Runnable command)</code> æäº¤çº¿ç¨‹æ± æ–¹æ³•ã€‚</li> <li>æŠ½è±¡ç±» <code>AbstractExecutorService</code>ï¼Œå®ç°äº†åŸºæœ¬é€šç”¨çš„æ¥å£æ–¹æ³•ã€‚</li> <li><code>ThreadPoolExecutor</code>ï¼Œæ˜¯æ•´ä¸ªçº¿ç¨‹æ± æœ€æ ¸å¿ƒçš„å·¥å…·ç±»æ–¹æ³•ï¼Œæ‰€æœ‰çš„å…¶ä»–ç±»å’Œæ¥å£ï¼Œä¸ºå›´ç»•è¿™ä¸ªç±»æ¥æä¾›å„è‡ªçš„åŠŸèƒ½ã€‚</li> <li><code>Worker</code>ï¼Œæ˜¯ä»»åŠ¡ç±»ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆæ‰§è¡Œçš„çº¿ç¨‹çš„æ–¹æ³•ã€‚</li> <li><code>RejectedExecutionHandler</code>ï¼Œæ˜¯æ‹’ç»ç­–ç•¥æ¥å£ï¼Œæœ‰å››ä¸ªå®ç°ç±»ï¼›<code>AbortPolicy(æŠ›å¼‚å¸¸æ–¹å¼æ‹’ç»)</code>ã€<code>DiscardPolicy(ç›´æ¥ä¸¢å¼ƒ)</code>ã€<code>DiscardOldestPolicy(ä¸¢å¼ƒå­˜æ´»æ—¶é—´æœ€é•¿çš„ä»»åŠ¡)</code>ã€<code>CallerRunsPolicy(è°æäº¤è°æ‰§è¡Œ)</code>ã€‚</li> <li><code>Executors</code>ï¼Œæ˜¯ç”¨äºåˆ›å»ºæˆ‘ä»¬å¸¸ç”¨çš„ä¸åŒç­–ç•¥çš„çº¿ç¨‹æ± ï¼Œ<code>newFixedThreadPool</code>ã€<code>newCachedThreadPool</code>ã€<code>newScheduledThreadPool</code>ã€<code>newSingleThreadExecutor</code>ã€‚</li></ul> <h4 id="é«˜3ä½ä¸ä½29ä½"><a href="#é«˜3ä½ä¸ä½29ä½" class="header-anchor">#</a> é«˜3ä½ä¸ä½29ä½</h4> <p><img src="/java/thread/interview-21-3.png" alt="pic"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> ctl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token function">ctlOf</span><span class="token punctuation">(</span><span class="token constant">RUNNING</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">COUNT_BITS</span> <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">SIZE</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CAPACITY</span>   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">RUNNING</span>    <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SHUTDOWN</span>   <span class="token operator">=</span>  <span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">STOP</span>       <span class="token operator">=</span>  <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TIDYING</span>    <span class="token operator">=</span>  <span class="token number">2</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TERMINATED</span> <span class="token operator">=</span>  <span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>åœ¨ <code>ThreadPoolExecutor</code> çº¿ç¨‹æ± å®ç°ç±»ä¸­ï¼Œä½¿ç”¨ <code>AtomicInteger</code> ç±»å‹çš„ <code>ctl</code> è®°å½•çº¿ç¨‹æ± çŠ¶æ€å’Œçº¿ç¨‹æ± æ•°é‡ã€‚åœ¨ä¸€ä¸ªç±»å‹ä¸Šè®°å½•å¤šä¸ªå€¼ï¼Œå®ƒé‡‡ç”¨çš„åˆ†å‰²æ•°æ®åŒºåŸŸï¼Œé«˜3ä½è®°å½•çº¿ç¨‹æ± çŠ¶æ€çŠ¶æ€ï¼Œä½29ä½å­˜å‚¨çº¿ç¨‹æ•°é‡ï¼Œé»˜è®¤ RUNNING çŠ¶æ€ï¼Œçº¿ç¨‹æ•°ä¸º0ä¸ªã€‚</p> <hr> <h4 id="çº¿ç¨‹æ± çŠ¶æ€"><a href="#çº¿ç¨‹æ± çŠ¶æ€" class="header-anchor">#</a> çº¿ç¨‹æ± çŠ¶æ€</h4> <p><img src="/java/thread/interview-21-4.png" alt="pic">
ä¸Šå›¾æ˜¯çº¿ç¨‹æ± ä¸­çš„çŠ¶æ€æµè½¬å…³ç³»ï¼ŒåŒ…æ‹¬å¦‚ä¸‹çŠ¶æ€ï¼š</p> <ul><li>RUNNINGï¼šè¿è¡ŒçŠ¶æ€ï¼Œæ¥å—æ–°çš„ä»»åŠ¡å¹¶ä¸”å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</li> <li>SHUTDOWNï¼šå…³é—­çŠ¶æ€(è°ƒç”¨äº†shutdownæ–¹æ³•)ã€‚ä¸æ¥å—æ–°ä»»åŠ¡ï¼Œ,ä½†æ˜¯è¦å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</li> <li>STOPï¼šåœæ­¢çŠ¶æ€(è°ƒç”¨äº†shutdownNowæ–¹æ³•)ã€‚ä¸æ¥å—æ–°ä»»åŠ¡ï¼Œä¹Ÿä¸å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå¹¶ä¸”è¦ä¸­æ–­æ­£åœ¨å¤„ç†çš„ä»»åŠ¡ã€‚</li> <li>TIDYINGï¼šæ‰€æœ‰çš„ä»»åŠ¡éƒ½å·²ç»ˆæ­¢äº†ï¼ŒworkerCountä¸º0ï¼Œçº¿ç¨‹æ± è¿›å…¥è¯¥çŠ¶æ€åä¼šè°ƒ terminated() æ–¹æ³•è¿›å…¥TERMINATED çŠ¶æ€ã€‚</li> <li>TERMINATEDï¼šç»ˆæ­¢çŠ¶æ€ï¼Œterminated() æ–¹æ³•è°ƒç”¨ç»“æŸåçš„çŠ¶æ€ã€‚</li></ul> <hr> <h4 id="æäº¤çº¿ç¨‹-execute"><a href="#æäº¤çº¿ç¨‹-execute" class="header-anchor">#</a> æäº¤çº¿ç¨‹(execute)</h4> <p><img src="/java/thread/interview-21-5.png" alt="pic"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬æŒ‡å®šçš„é˜»å¡é˜Ÿåˆ—</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">;</span>

<span class="token comment">//å†æ¬¡æé†’ï¼Œè¿™é‡Œæ²¡åŠ é”ï¼ï¼è¯¥æœ‰ä»€ä¹ˆæ„è¯†ä¸ç”¨æˆ‘è¯´äº†å§ï¼Œæ‰€ä»¥è¯´ctlæ‰ä¼šä½¿ç”¨åŸå­ç±»ã€‚</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//å¦‚æœä»»åŠ¡ä¸ºnullï¼Œé‚£æ‰§è¡Œä¸ªå¯‚å¯ï¼Œæ‰€ä»¥è¯´ç›´æ¥ç©ºæŒ‡é’ˆ</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//è·å–ctlçš„å€¼ï¼Œä¸€ä¼šè¦è¯»å–ä¿¡æ¯çš„</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//åˆ¤æ–­å·¥ä½œçº¿ç¨‹æ•°é‡æ˜¯å¦å°äºæ ¸å¿ƒçº¿ç¨‹æ•°</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">//å¦‚æœæ˜¯ï¼Œé‚£ä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€ï¼Œç›´æ¥åŠ æ–°çš„çº¿ç¨‹æ‰§è¡Œï¼Œç„¶åè¿”å›å³å¯</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¦‚æœçº¿ç¨‹æ·»åŠ å¤±è´¥ï¼ˆæœ‰å¯èƒ½å…¶ä»–çº¿ç¨‹ä¹Ÿåœ¨å¯¹çº¿ç¨‹æ± è¿›è¡Œæ“ä½œï¼‰ï¼Œé‚£å°±æ›´æ–°ä¸€ä¸‹cçš„å€¼</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> workQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//ç»§ç»­åˆ¤æ–­ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ± æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œé‚£å°±å°è¯•å‘é˜»å¡é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„ç­‰å¾…ä»»åŠ¡</span>
        <span class="token keyword">int</span> recheck <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//å†æ¬¡è·å–ctlçš„å€¼</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isRunning</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">remove</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//è¿™é‡Œæ˜¯å†æ¬¡ç¡®è®¤å½“å‰çº¿ç¨‹æ± æ˜¯å¦å…³é—­ï¼Œå¦‚æœæ·»åŠ ç­‰å¾…ä»»åŠ¡åçº¿ç¨‹æ± å…³é—­äº†ï¼Œé‚£å°±æŠŠåˆšåˆšåŠ è¿›å»ä»»åŠ¡çš„åˆæ‹¿å‡ºæ¥</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//ç„¶åç›´æ¥æ‹’ç»å½“å‰ä»»åŠ¡çš„æäº¤ï¼ˆä¼šæ ¹æ®æˆ‘ä»¬çš„æ‹’ç»ç­–ç•¥å†³å®šå¦‚ä½•è¿›è¡Œæ‹’ç»æ“ä½œï¼‰</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">//å¦‚æœè¿™ä¸ªæ—¶å€™çº¿ç¨‹æ± ä¾ç„¶åœ¨è¿è¡ŒçŠ¶æ€ï¼Œé‚£ä¹ˆå°±æ£€æŸ¥ä¸€ä¸‹å½“å‰å·¥ä½œçº¿ç¨‹æ•°æ˜¯å¦ä¸º0ï¼Œå¦‚æœæ˜¯é‚£å°±ç›´æ¥æ·»åŠ æ–°çº¿ç¨‹æ‰§è¡Œ</span>
            <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//æ·»åŠ ä¸€ä¸ªæ–°çš„éæ ¸å¿ƒçº¿ç¨‹ï¼Œä½†æ˜¯æ³¨æ„æ²¡æ·»åŠ ä»»åŠ¡</span>
      	<span class="token comment">//å…¶ä»–æƒ…å†µå°±å•¥ä¹Ÿä¸ç”¨åšäº†</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//è¿™ç§æƒ…å†µè¦ä¹ˆå°±æ˜¯çº¿ç¨‹æ± æ²¡æœ‰è¿è¡Œï¼Œè¦ä¹ˆå°±æ˜¯é˜Ÿåˆ—æ»¡äº†ï¼ŒæŒ‰ç…§æˆ‘ä»¬ä¹‹å‰çš„è§„åˆ™ï¼Œæ ¸å¿ƒçº¿ç¨‹æ•°å·²æ»¡ä¸”é˜Ÿåˆ—å·²æ»¡ï¼Œé‚£ä¹ˆä¼šç›´æ¥æ·»åŠ æ–°çš„éæ ¸å¿ƒçº¿ç¨‹ï¼Œä½†æ˜¯å¦‚æœå·²ç»æ·»åŠ åˆ°æœ€å¤§æ•°é‡ï¼Œè¿™é‡Œè‚¯å®šæ˜¯ä¼šå¤±è´¥çš„</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//ç¡®å®è£…ä¸ä¸‹äº†ï¼Œåªèƒ½æ‹’ç»</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>åœ¨é˜…è¯»è¿™éƒ¨åˆ†æºç çš„æ—¶å€™ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä»¬è‡ªå·±å®ç°çš„çº¿ç¨‹æ± ã€‚å…¶å®æœ€ç»ˆçš„ç›®çš„éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯è¿™æ®µè¢«æäº¤çš„çº¿ç¨‹ï¼Œ<code>å¯åŠ¨æ‰§è¡Œ</code>ã€<code>åŠ å…¥é˜Ÿåˆ—</code>ã€<code>å†³ç­–ç­–ç•¥</code>ï¼Œè¿™ä¸‰ç§æ–¹å¼ã€‚</p> <ul><li><code>ctl.get()</code>ï¼Œå–çš„æ˜¯è®°å½•çº¿ç¨‹çŠ¶æ€å’Œçº¿ç¨‹ä¸ªæ•°çš„å€¼ï¼Œæœ€ç»ˆéœ€è¦ä½¿ç”¨æ–¹æ³• <code>workerCountOf()</code>ï¼Œæ¥è·å–å½“å‰çº¿ç¨‹æ•°é‡ã€‚<code>workerCountOf</code> æ‰§è¡Œçš„æ˜¯ <code>c &amp; CAPACITY</code> è¿ç®—</li> <li>æ ¹æ®å½“å‰çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡ï¼Œä¸æ ¸å¿ƒçº¿ç¨‹æ•° <code>corePoolSize</code>åšå¯¹æ¯”ï¼Œå°äºåˆ™è¿›è¡Œæ·»åŠ çº¿ç¨‹åˆ°ä»»åŠ¡æ‰§è¡Œé˜Ÿåˆ—ã€‚</li> <li>å¦‚æœè¯´æ­¤æ—¶çº¿ç¨‹æ•°å·²æ»¡ï¼Œé‚£ä¹ˆåˆ™éœ€è¦åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦ä¸ºè¿è¡ŒçŠ¶æ€ <code>isRunning(c)</code>ã€‚å¦‚æœæ˜¯è¿è¡ŒçŠ¶æ€åˆ™æŠŠä¸èƒ½è¢«æ‰§è¡Œçš„çº¿ç¨‹æ”¾å…¥çº¿ç¨‹é˜Ÿåˆ—ä¸­ã€‚</li> <li>æ”¾å…¥çº¿ç¨‹é˜Ÿåˆ—ä»¥åï¼Œè¿˜éœ€è¦é‡æ–°åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¿è¡Œä»¥åŠç§»é™¤æ“ä½œï¼Œå¦‚æœéè¿è¡Œä¸”ç§»é™¤ï¼Œåˆ™è¿›è¡Œæ‹’ç»ç­–ç•¥ã€‚å¦åˆ™åˆ¤æ–­çº¿ç¨‹æ•°é‡ä¸º0åæ·»åŠ æ–°çº¿ç¨‹ã€‚</li> <li>æœ€åå°±æ˜¯å†æ¬¡å°è¯•æ·»åŠ ä»»åŠ¡æ‰§è¡Œï¼Œæ­¤æ—¶æ–¹æ³• <code>addWorker</code> çš„ç¬¬äºŒä¸ªå…¥å‚æ˜¯ falseï¼Œæœ€ç»ˆä¼šå½±å“æ·»åŠ æ‰§è¡Œä»»åŠ¡æ•°é‡åˆ¤æ–­ã€‚å¦‚æœæ·»åŠ å¤±è´¥åˆ™è¿›è¡Œæ‹’ç»ç­–ç•¥ã€‚</li></ul> <hr> <h4 id="æ·»åŠ æ‰§è¡Œä»»åŠ¡-addworker"><a href="#æ·»åŠ æ‰§è¡Œä»»åŠ¡-addworker" class="header-anchor">#</a> æ·»åŠ æ‰§è¡Œä»»åŠ¡(addWorker)</h4> <p><img src="/java/thread/interview-21-6.png" alt="pic"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> firstTask<span class="token punctuation">,</span> <span class="token keyword">boolean</span> core<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//å¢åŠ çº¿ç¨‹æ•°é‡</span>
  	<span class="token comment">//è¿™é‡Œç»™æœ€å¤–å±‚å¾ªç¯æ‰“äº†ä¸ªæ ‡ç­¾ï¼Œæ–¹ä¾¿ä¸€ä¼šçš„è·³è½¬æ“ä½œ</span>
    retry<span class="token operator">:</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">//æ— é™å¾ªç¯ï¼Œè€å¥—è·¯äº†ï¼Œæ³¨æ„è¿™é‡Œå…¨ç¨‹æ²¡åŠ é”</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//è·å–ctlå€¼</span>
        <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è§£æå½“å‰çš„è¿è¡ŒçŠ¶æ€</span>

        <span class="token comment">// Check if queue empty only if necessary.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;=</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span>   <span class="token comment">//åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦ä¸æ˜¯å¤„äºè¿è¡ŒçŠ¶æ€</span>
            <span class="token operator">!</span> <span class="token punctuation">(</span>rs <span class="token operator">==</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span>   <span class="token comment">//å¦‚æœä¸æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œåˆ¤æ–­çº¿ç¨‹æ˜¯SHUTDOWNçŠ¶æ€å¹¶ã€ä»»åŠ¡ä¸ä¸ºnullã€ç­‰å¾…é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåªè¦æœ‰å…¶ä¸­ä¸€è€…ä¸æ»¡è¶³ï¼Œç›´æ¥è¿”å›falseï¼Œæ·»åŠ å¤±è´¥</span>
               firstTask <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>   
               <span class="token operator">!</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//å†…å±‚åˆä¸€è½®æ— é™å¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯æ˜¯ä¸ºäº†å°†çº¿ç¨‹è®¡æ•°å¢åŠ ï¼Œç„¶åæ‰å¯ä»¥çœŸæ­£åœ°æ·»åŠ ä¸€ä¸ªæ–°çš„çº¿ç¨‹</span>
            <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è§£æå½“å‰çš„å·¥ä½œçº¿ç¨‹æ•°é‡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wc <span class="token operator">&gt;=</span> <span class="token constant">CAPACITY</span> <span class="token operator">||</span>
                wc <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>core <span class="token operator">?</span> corePoolSize <span class="token operator">:</span> maximumPoolSize<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">//åˆ¤æ–­ä¸€ä¸‹è¿˜è£…å¾—ä¸‹ä¸ï¼Œå¦‚æœè£…å¾—ä¸‹ï¼Œçœ‹çœ‹æ˜¯æ ¸å¿ƒçº¿ç¨‹è¿˜æ˜¯éæ ¸å¿ƒçº¿ç¨‹ï¼Œå¦‚æœæ˜¯æ ¸å¿ƒçº¿ç¨‹ï¼Œä¸èƒ½å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°çš„é™åˆ¶ï¼Œå¦‚æœæ˜¯éæ ¸å¿ƒçº¿ç¨‹ï¼Œä¸èƒ½å¤§äºæœ€å¤§çº¿ç¨‹æ•°é™åˆ¶</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndIncrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">//CASè‡ªå¢çº¿ç¨‹è®¡æ•°ï¼Œå¦‚æœå¢åŠ æˆåŠŸï¼Œä»»åŠ¡å®Œæˆï¼Œç›´æ¥è·³å‡ºç»§ç»­</span>
                <span class="token keyword">break</span> retry<span class="token punctuation">;</span>    <span class="token comment">//æ³¨æ„è¿™é‡Œè¦ç›´æ¥è·³å‡ºæœ€å¤–å±‚å¾ªç¯ï¼Œæ‰€ä»¥ç”¨åˆ°äº†æ ‡ç­¾ï¼ˆç±»ä¼¼äºgotoè¯­å¥ï¼‰</span>
            c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// å¦‚æœCASå¤±è´¥ï¼Œæ›´æ–°ä¸€ä¸‹cçš„å€¼</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> rs<span class="token punctuation">)</span>    <span class="token comment">//å¦‚æœCASå¤±è´¥çš„åŸå› æ˜¯å› ä¸ºçº¿ç¨‹æ± çŠ¶æ€å’Œä¸€å¼€å§‹çš„ä¸ä¸€æ ·äº†ï¼Œé‚£ä¹ˆå°±é‡æ–°ä»å¤–å±‚å¾ªç¯å†æ¥ä¸€æ¬¡</span>
                <span class="token keyword">continue</span> retry<span class="token punctuation">;</span>    <span class="token comment">//æ³¨æ„è¿™é‡Œè¦ç›´æ¥ä»æœ€å¤–å±‚å¾ªç¯ç»§ç»­ï¼Œæ‰€ä»¥ç”¨åˆ°äº†æ ‡ç­¾ï¼ˆç±»ä¼¼äºgotoè¯­å¥ï¼‰</span>
            <span class="token comment">// å¦‚æœæ˜¯å…¶ä»–åŸå› å¯¼è‡´çš„CASå¤±è´¥ï¼Œé‚£åªå¯èƒ½æ˜¯å…¶ä»–çº¿ç¨‹åŒæ—¶åœ¨è‡ªå¢ï¼Œæ‰€ä»¥é‡æ–°å†æ¥ä¸€æ¬¡å†…å±‚å¾ªç¯</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//åˆ›å»ºå¯åŠ¨çº¿ç¨‹</span>
  	<span class="token comment">//å¥½äº†ï¼Œçº¿ç¨‹è®¡æ•°è‡ªå¢ä¹Ÿå®Œäº†ï¼Œæ¥ç€å°±æ˜¯æ·»åŠ æ–°çš„å·¥ä½œçº¿ç¨‹äº†</span>
    <span class="token keyword">boolean</span> workerStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>   <span class="token comment">//å·¥ä½œçº¿ç¨‹æ˜¯å¦å·²å¯åŠ¨</span>
    <span class="token keyword">boolean</span> workerAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token comment">//å·¥ä½œçº¿ç¨‹æ˜¯å¦å·²æ·»åŠ </span>
    <span class="token class-name">Worker</span> w <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>     <span class="token comment">//æš‚æ—¶ç†è§£ä¸ºå·¥ä½œçº¿ç¨‹ï¼Œåˆ«æ€¥ï¼Œæˆ‘ä»¬ä¹‹åä¼šè§£è¯»Workerç±»</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>firstTask<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//åˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹ï¼Œä¼ å…¥æˆ‘ä»¬æäº¤çš„ä»»åŠ¡</span>
        <span class="token keyword">final</span> <span class="token class-name">Thread</span> t <span class="token operator">=</span> w<span class="token punctuation">.</span>thread<span class="token punctuation">;</span>    <span class="token comment">//æ‹¿åˆ°å·¥ä½œçº¿ç¨‹ä¸­å°è£…çš„Threadå¯¹è±¡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">//å¦‚æœçº¿ç¨‹ä¸ä¸ºnullï¼Œé‚£å°±å¯ä»¥å®‰æ’å¹²æ´»äº†</span>
            <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>      <span class="token comment">//åˆæ˜¯ReentrantLockåŠ é”ç¯èŠ‚ï¼Œè¿™é‡Œå¼€å§‹å°±æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è¿›å…¥äº†</span>
            mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// Recheck while holding lock.</span>
                <span class="token comment">// Back out on ThreadFactory failure or if</span>
                <span class="token comment">// shut down before lock acquired.</span>
                <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è·å–å½“å‰çº¿ç¨‹çš„è¿è¡ŒçŠ¶æ€</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&lt;</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">||</span>
                    <span class="token punctuation">(</span>rs <span class="token operator">==</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span> firstTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">//åªæœ‰å½“å‰çº¿ç¨‹æ± æ˜¯æ­£åœ¨è¿è¡ŒçŠ¶æ€ï¼Œæˆ–æ˜¯SHUTDOWNçŠ¶æ€ä¸”firstTaskä¸ºç©ºï¼Œé‚£ä¹ˆå°±ç»§ç»­</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// æ£€æŸ¥ä¸€ä¸‹çº¿ç¨‹æ˜¯å¦æ­£åœ¨è¿è¡ŒçŠ¶æ€</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalThreadStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//å¦‚æœæ˜¯é‚£è‚¯å®šæ˜¯ä¸èƒ½è¿è¡Œæˆ‘ä»¬çš„ä»»åŠ¡çš„</span>
                    workers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ç›´æ¥å°†æ–°åˆ›å»ºçš„Workä¸¢è¿› workers é›†åˆä¸­</span>
                    <span class="token keyword">int</span> s <span class="token operator">=</span> workers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//çœ‹çœ‹å½“å‰workersçš„å¤§å°</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;</span> largestPoolSize<span class="token punctuation">)</span>   <span class="token comment">//è¿™é‡Œæ˜¯è®°å½•çº¿ç¨‹æ± è¿è¡Œä»¥æ¥ï¼Œå†å²ä¸Šçš„æœ€å¤šçº¿ç¨‹æ•°</span>
                        largestPoolSize <span class="token operator">=</span> s<span class="token punctuation">;</span>
                    workerAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>   <span class="token comment">//å·¥ä½œçº¿ç¨‹å·²æ·»åŠ </span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//è§£é”</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>workerAdded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//å¯åŠ¨çº¿ç¨‹</span>
                workerStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token comment">//å·¥ä½œçº¿ç¨‹å·²å¯åŠ¨</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> workerStarted<span class="token punctuation">)</span>    <span class="token comment">//å¦‚æœçº¿ç¨‹åœ¨ä¸Šé¢çš„å¯åŠ¨è¿‡ç¨‹ä¸­å¤±è´¥äº†</span>
            <span class="token function">addWorkerFailed</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å°†wç§»å‡ºworkerså¹¶å°†è®¡æ•°å™¨-1ï¼Œæœ€åå¦‚æœçº¿ç¨‹æ± æ˜¯ç»ˆæ­¢çŠ¶æ€ï¼Œä¼šå°è¯•åŠ é€Ÿç»ˆæ­¢çº¿ç¨‹æ± </span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> workerStarted<span class="token punctuation">;</span>   <span class="token comment">//è¿”å›æ˜¯å¦æˆåŠŸ</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>æ·»åŠ æ‰§è¡Œä»»åŠ¡çš„æµç¨‹å¯ä»¥åˆ†ä¸ºä¸¤å—çœ‹ï¼Œä¸Šé¢ä»£ç éƒ¨åˆ†æ˜¯ç”¨äºè®°å½•çº¿ç¨‹æ•°é‡ã€ä¸‹é¢ä»£ç éƒ¨åˆ†æ˜¯åœ¨ç‹¬å é”é‡Œåˆ›å»ºæ‰§è¡Œçº¿ç¨‹å¹¶å¯åŠ¨ã€‚è¿™éƒ¨åˆ†ä»£ç åœ¨ä¸çœ‹é”ã€CASç­‰æ“ä½œçš„æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆå°±å’Œæˆ‘ä»¬æœ€å¼€å§‹æ‰‹å†™çš„çº¿ç¨‹æ± åŸºæœ¬ä¸€æ ·äº†</p> <ul><li><code>if (rs &gt;= SHUTDOWN &amp;&amp;! (rs == SHUTDOWN &amp;&amp;firstTask == null &amp;&amp;! workQueue.isEmpty()))</code>ï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹æ± çŠ¶æ€ï¼Œæ˜¯å¦ä¸º <code>SHUTDOWN</code>ã€<code>STOP</code>ã€<code>TIDYING</code>ã€<code>TERMINATED</code>ä¸­çš„ä¸€ä¸ªã€‚å¹¶ä¸”å½“å‰çŠ¶æ€ä¸º <code>SHUTDOWN</code>ã€ä¸”ä¼ å…¥çš„ä»»åŠ¡ä¸º nullï¼ŒåŒæ—¶é˜Ÿåˆ—ä¸ä¸ºç©ºã€‚é‚£ä¹ˆå°±è¿”å› falseã€‚</li> <li><code>compareAndIncrementWorkerCount</code>ï¼ŒCAS æ“ä½œï¼Œå¢åŠ çº¿ç¨‹æ•°é‡ï¼ŒæˆåŠŸå°±ä¼šè·³å‡ºæ ‡è®°çš„å¾ªç¯ä½“ã€‚</li> <li><code>runStateOf(c) != rs</code>ï¼Œæœ€åæ˜¯çº¿ç¨‹æ± çŠ¶æ€åˆ¤æ–­ï¼Œå†³å®šæ˜¯å¦å¾ªç¯ã€‚</li> <li>åœ¨çº¿ç¨‹æ± æ•°é‡è®°å½•æˆåŠŸåï¼Œåˆ™éœ€è¦è¿›å…¥åŠ é”ç¯èŠ‚ï¼Œåˆ›å»ºæ‰§è¡Œçº¿ç¨‹ï¼Œå¹¶è®°å½•çŠ¶æ€ã€‚åœ¨æœ€åå¦‚æœåˆ¤æ–­æ²¡æœ‰å¯åŠ¨æˆåŠŸï¼Œåˆ™éœ€è¦æ‰§è¡Œ <code>addWorkerFailed</code> æ–¹æ³•ï¼Œå‰”é™¤åˆ°çº¿ç¨‹æ–¹æ³•ç­‰æ“ä½œã€‚</li></ul> <hr> <h4 id="worker"><a href="#worker" class="header-anchor">#</a> Worker</h4> <p>å®ƒç»§æ‰¿è‡ªAbstractQueuedSynchronizerï¼Œæ—¶éš”ä¸¤ç« ï¼Œå±…ç„¶å†æ¬¡é‡åˆ°AQSï¼Œé‚£ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæœ¬èº«å°±æ˜¯ä¸€æŠŠé”ï¼š</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Worker</span>
    <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span>
    <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token comment">//ç”¨æ¥å¹²æ´»çš„çº¿ç¨‹</span>
    <span class="token keyword">final</span> <span class="token class-name">Thread</span> thread<span class="token punctuation">;</span>
    <span class="token comment">//è¦æ‰§è¡Œçš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œæ„é€ æ—¶å°±ç¡®å®šäº†çš„</span>
    <span class="token class-name">Runnable</span> firstTask<span class="token punctuation">;</span>
    <span class="token comment">//å¹²æ´»æ•°é‡è®¡æ•°å™¨ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªçº¿ç¨‹å®Œæˆäº†å¤šå°‘ä¸ªä»»åŠ¡</span>
    <span class="token keyword">volatile</span> <span class="token keyword">long</span> completedTasks<span class="token punctuation">;</span>

    <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> firstTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ‰§è¡ŒTaskä¹‹å‰ä¸è®©ä¸­æ–­ï¼Œå°†AQSçš„stateè®¾å®šä¸º-1</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>firstTask <span class="token operator">=</span> firstTask<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token function">getThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//é€šè¿‡é¢„å®šä¹‰æˆ–æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„çº¿ç¨‹å·¥å‚åˆ›å»ºçº¿ç¨‹</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//çœŸæ­£å¼€å§‹å¹²æ´»ï¼ŒåŒ…æ‹¬å½“å‰æ´»å¹²å®Œäº†åˆè¦ç­‰æ–°çš„æ´»æ¥ï¼Œå°±ä»è¿™é‡Œå¼€å§‹ï¼Œä¸€ä¼šè¯¦ç»†ä»‹ç»</span>
    <span class="token punctuation">}</span>

   	<span class="token comment">//0å°±æ˜¯æ²¡åŠ é”ï¼Œ1å°±æ˜¯å·²åŠ é”</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>æœ€åæˆ‘ä»¬æ¥çœ‹çœ‹ä¸€ä¸ªWorkeråˆ°åº•æ˜¯æ€ä¹ˆåœ¨è¿›è¡Œä»»åŠ¡çš„ï¼š</p> <hr> <h4 id="æ‰§è¡Œçº¿ç¨‹-runworker"><a href="#æ‰§è¡Œçº¿ç¨‹-runworker" class="header-anchor">#</a> æ‰§è¡Œçº¿ç¨‹(runWorker)</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token class-name">Worker</span> w<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> wt <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//è·å–å½“å‰çº¿ç¨‹</span>
    <span class="token class-name">Runnable</span> task <span class="token operator">=</span> w<span class="token punctuation">.</span>firstTask<span class="token punctuation">;</span>    <span class="token comment">//å–å‡ºè¦æ‰§è¡Œçš„ä»»åŠ¡</span>
    w<span class="token punctuation">.</span>firstTask <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>   <span class="token comment">//ç„¶åæŠŠWorkerä¸­çš„ä»»åŠ¡è®¾å®šä¸ºnull</span>
    w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å› ä¸ºä¸€å¼€å§‹ä¸º-1ï¼Œè¿™é‡Œæ˜¯é€šè¿‡unlockæ“ä½œå°†å…¶ä¿®æ”¹å›0ï¼Œåªæœ‰stateå¤§äºç­‰äº0æ‰èƒ½å“åº”ä¸­æ–­</span>
    <span class="token keyword">boolean</span> completedAbruptly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      	<span class="token comment">//åªè¦ä»»åŠ¡ä¸ä¸ºnullï¼Œæˆ–æ˜¯ä»»åŠ¡ä¸ºç©ºä½†æ˜¯å¯ä»¥ä»ç­‰å¾…é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆå°±å¼€å§‹æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œæ³¨æ„è¿™é‡Œæ˜¯æ— é™å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœå½“å‰æ²¡æœ‰ä»»åŠ¡äº†ï¼Œé‚£ä¹ˆä¼šåœ¨getTaskæ–¹æ³•ä¸­å¡ä½ï¼Œå› ä¸ºè¦ä»é˜»å¡é˜Ÿåˆ—ä¸­ç­‰ç€å–ä»»åŠ¡</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>task <span class="token operator">=</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¯¹å½“å‰WorkeråŠ é”ï¼Œè¿™é‡Œå…¶å®å¹¶ä¸æ˜¯é˜²å…¶ä»–çº¿ç¨‹ï¼Œè€Œæ˜¯åœ¨shutdownæ—¶ä¿æŠ¤æ­¤ä»»åŠ¡çš„è¿è¡Œ</span>
            
          <span class="token comment">//ç”±äºçº¿ç¨‹æ± åœ¨STOPçŠ¶æ€åŠä»¥ä¸Šä¼šç¦æ­¢æ–°çº¿ç¨‹åŠ å…¥å¹¶ä¸”ä¸­æ–­æ­£åœ¨è¿›è¡Œçš„çº¿ç¨‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">STOP</span><span class="token punctuation">)</span> <span class="token operator">||</span>   <span class="token comment">//åªè¦çº¿ç¨‹æ± æ˜¯STOPåŠä»¥ä¸Šçš„çŠ¶æ€ï¼Œé‚£è‚¯å®šæ˜¯ä¸èƒ½å¼€å§‹æ–°ä»»åŠ¡çš„</span>
                 <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    					 <span class="token comment">//çº¿ç¨‹æ˜¯å¦å·²ç»è¢«æ‰“ä¸Šä¸­æ–­æ ‡è®°å¹¶ä¸”çº¿ç¨‹ä¸€å®šæ˜¯STOPåŠä»¥ä¸Š</span>
                  <span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">STOP</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token operator">!</span>wt<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//å†æ¬¡ç¡®ä¿çº¿ç¨‹è¢«æ²¡æœ‰æ‰“ä¸Šä¸­æ–­æ ‡è®°</span>
                wt<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//æ‰“ä¸­æ–­æ ‡è®°</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">beforeExecute</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//å¼€å§‹ä¹‹å‰çš„å‡†å¤‡å·¥ä½œï¼Œè¿™é‡Œæš‚æ—¶æ²¡æœ‰å®ç°</span>
                <span class="token class-name">Throwable</span> thrown <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    task<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//OKï¼Œå¼€å§‹æ‰§è¡Œä»»åŠ¡</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> x<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> x<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    thrown <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token function">afterExecute</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> thrown<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æ‰§è¡Œä¹‹åçš„å·¥ä½œï¼Œä¹Ÿæ²¡å®ç°</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                task <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token comment">//ä»»åŠ¡å·²å®Œæˆï¼Œä¸éœ€è¦äº†</span>
                w<span class="token punctuation">.</span>completedTasks<span class="token operator">++</span><span class="token punctuation">;</span>   <span class="token comment">//ä»»åŠ¡å®Œæˆæ•°++</span>
                w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è§£é”</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        completedAbruptly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      	<span class="token comment">//å¦‚æœèƒ½èµ°åˆ°è¿™ä¸€æ­¥ï¼Œé‚£è¯´æ˜ä¸Šé¢çš„å¾ªç¯è‚¯å®šæ˜¯è·³å‡ºäº†ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªWorkerå¯ä»¥ä¸¢å¼ƒäº†</span>
      	<span class="token comment">//æ‰€ä»¥è¿™é‡Œä¼šç›´æ¥å°† Worker ä» workers é‡Œåˆ é™¤æ‰</span>
        <span class="token function">processWorkerExit</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> completedAbruptly<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>å…¶å®ï¼Œæœ‰äº†æ‰‹å†™çº¿ç¨‹æ± çš„åŸºç¡€ï¼Œåˆ°è¿™ä¹Ÿå°±åŸºæœ¬äº†è§£äº†ï¼Œçº¿ç¨‹æ± åœ¨å¹²å˜›ã€‚åˆ°è¿™æœ€æ ¸å¿ƒçš„ç‚¹å°±æ˜¯ task.run() è®©çº¿ç¨‹è·‘èµ·æ¥ã€‚é¢å¤–å†é™„å¸¦ä¸€äº›å…¶ä»–æµç¨‹å¦‚ä¸‹ï¼›</p> <ul><li>beforeExecuteã€afterExecuteï¼Œçº¿ç¨‹æ‰§è¡Œçš„å‰ååšä¸€äº›ç»Ÿè®¡ä¿¡æ¯ã€‚</li> <li>å¦å¤–è¿™é‡Œçš„é”æ“ä½œæ˜¯ Worker ç»§æ‰¿ AQS è‡ªå·±å®ç°çš„ä¸å¯é‡å…¥çš„ç‹¬å é”ã€‚</li> <li>processWorkerExitï¼Œå¦‚æœä½ æ„Ÿå…´è¶£ï¼Œç±»ä¼¼è¿™æ ·çš„æ–¹æ³•ä¹Ÿå¯ä»¥æ·±å…¥äº†è§£ä¸‹ã€‚åœ¨çº¿ç¨‹é€€å‡ºæ—¶å€™workersåšåˆ°ä¸€äº›ç§»é™¤å¤„ç†ä»¥åŠå®Œæˆä»»åŠ¡æ•°ç­‰ï¼Œä¹Ÿéå¸¸æœ‰æ„æ€</li></ul> <p>é‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆä»é˜»å¡é˜Ÿåˆ—é‡Œé¢è·å–ä»»åŠ¡çš„å‘¢ï¼š</p> <hr> <h4 id="é˜Ÿåˆ—è·å–ä»»åŠ¡-gettask"><a href="#é˜Ÿåˆ—è·å–ä»»åŠ¡-gettask" class="header-anchor">#</a> é˜Ÿåˆ—è·å–ä»»åŠ¡(getTask)</h4> <p>å¦‚æœä½ å·²ç»å¼€å§‹é˜…è¯»æºç ï¼Œå¯ä»¥åœ¨ runWorker æ–¹æ³•ä¸­ï¼Œçœ‹åˆ°è¿™æ ·ä¸€å¥å¾ªç¯ä»£ç  while (task != null || (task = getTask()) != null)ã€‚è¿™ä¸æˆ‘ä»¬æ‰‹å†™çº¿ç¨‹æ± ä¸­æ“ä½œçš„æ–¹å¼æ˜¯ä¸€æ ·çš„ï¼Œæ ¸å¿ƒç›®çš„å°±æ˜¯ä»é˜Ÿåˆ—ä¸­è·å–çº¿ç¨‹æ–¹æ³•ã€‚</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Runnable</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// Did the last poll() time out?</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">//æ— é™å¾ªç¯è·å–</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//è·å–ctl </span>
        <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//è§£æçº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€</span>

        <span class="token comment">// Check if queue empty only if necessary.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;=</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;=</span> <span class="token constant">STOP</span> <span class="token operator">||</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">//åˆ¤æ–­æ˜¯ä¸æ˜¯æ²¡æœ‰å¿…è¦å†æ‰§è¡Œç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡äº†ï¼Œä¹Ÿå°±æ˜¯å¤„äºå…³é—­çº¿ç¨‹æ± çš„çŠ¶æ€äº†</span>
            <span class="token function">decrementWorkerCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//ç›´æ¥å‡å°‘ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ•°é‡</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token comment">//è¿”å›nullï¼Œè¿™æ ·ä¸Šé¢çš„runWorkerå°±ç›´æ¥ç»“æŸäº†ï¼Œä¸‹åŒ</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//å¦‚æœçº¿ç¨‹æ± è¿è¡Œæ­£å¸¸ï¼Œé‚£å°±è·å–å½“å‰çš„å·¥ä½œçº¿ç¨‹æ•°é‡</span>

        <span class="token comment">// Are workers subject to culling?</span>
        <span class="token keyword">boolean</span> timed <span class="token operator">=</span> allowCoreThreadTimeOut <span class="token operator">||</span> wc <span class="token operator">&gt;</span> corePoolSize<span class="token punctuation">;</span>   <span class="token comment">//å¦‚æœçº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°æˆ–æ˜¯å…è®¸æ ¸å¿ƒçº¿ç¨‹ç­‰å¾…è¶…æ—¶ï¼Œé‚£ä¹ˆå°±æ ‡è®°ä¸ºå¯è¶…æ—¶çš„</span>

      	<span class="token comment">//è¶…æ—¶æˆ–maximumPoolSizeåœ¨è¿è¡ŒæœŸé—´è¢«ä¿®æ”¹äº†ï¼Œå¹¶ä¸”çº¿ç¨‹æ•°å¤§äº1æˆ–ç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼Œé‚£ä¹Ÿæ˜¯ä¸èƒ½è·å–åˆ°ä»»åŠ¡çš„</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>wc <span class="token operator">&gt;</span> maximumPoolSize <span class="token operator">||</span> <span class="token punctuation">(</span>timed <span class="token operator">&amp;&amp;</span> timedOut<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>wc <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndDecrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//å¦‚æœCASå‡å°‘å·¥ä½œçº¿ç¨‹æˆåŠŸ</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token comment">//è¿”å›null</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>   <span class="token comment">//å¦åˆ™å¼€ä¸‹ä¸€è½®å¾ªç¯</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Runnable</span> r <span class="token operator">=</span> timed <span class="token operator">?</span>
                workQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span> <span class="token operator">:</span>   <span class="token comment">//å¦‚æœå¯è¶…æ—¶ï¼Œé‚£ä¹ˆæœ€å¤šç­‰åˆ°è¶…æ—¶æ—¶é—´</span>
                workQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¦‚æœä¸å¯è¶…æ—¶ï¼Œé‚£å°±ä¸€ç›´ç­‰ç€æ‹¿ä»»åŠ¡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token comment">//å¦‚æœæˆåŠŸæ‹¿åˆ°ä»»åŠ¡ï¼Œokï¼Œè¿”å›</span>
                <span class="token keyword">return</span> r<span class="token punctuation">;</span>
            timedOut <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>   <span class="token comment">//å¦åˆ™å°±æ˜¯è¶…æ—¶äº†ï¼Œä¸‹ä¸€è½®å¾ªç¯å°†ç›´æ¥è¿”å›null</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> retry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      	<span class="token comment">//å¼€ä¸‹ä¸€è½®å¾ªç¯å§</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><ul><li>getTask æ–¹æ³•ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ç­‰å¾…è¢«æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ä¸€æ¡æ¡å¾€å‡ºæ‹¿çº¿ç¨‹æ–¹æ³•ã€‚</li> <li>if (rs &gt;= SHUTDOWN ...ï¼Œåˆ¤æ–­çº¿ç¨‹æ˜¯å¦å…³é—­ã€‚</li> <li>wc = workerCountOf(c)ï¼Œwc &gt; corePoolSizeï¼Œå¦‚æœå·¥ä½œçº¿ç¨‹æ•°è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°é‡ corePoolSize å¹¶ä¸” workQueue ä¸ä¸ºç©ºï¼Œåˆ™å¢åŠ å·¥ä½œçº¿ç¨‹ã€‚ä½†å¦‚æœè¶…æ—¶æœªè·å–åˆ°çº¿ç¨‹ï¼Œåˆ™ä¼šæŠŠå¤§äº corePoolSize çš„çº¿ç¨‹é”€æ¯æ‰ã€‚</li> <li>timedï¼Œæ˜¯ allowCoreThreadTimeOut å¾—æ¥çš„ã€‚æœ€ç»ˆ timed ä¸º true æ—¶ï¼Œåˆ™é€šè¿‡é˜»å¡é˜Ÿåˆ—çš„pollæ–¹æ³•è¿›è¡Œè¶…æ—¶æ§åˆ¶ã€‚</li> <li>å¦‚æœåœ¨ keepAliveTime æ—¶é—´å†…æ²¡æœ‰è·å–åˆ°ä»»åŠ¡ï¼Œåˆ™è¿”å›nullã€‚å¦‚æœä¸ºfalseï¼Œåˆ™é˜»å¡ã€‚</li></ul> <p>è™½ç„¶æˆ‘ä»¬çš„æºç è§£è¯»è¶Šæ¥è¶Šæ·±ï¼Œä½†æ˜¯åªè¦å„ä½çš„æ€è·¯ä¸æ–­ï¼Œä¾ç„¶æ˜¯å¯ä»¥ç»§ç»­å¾€ä¸‹çœ‹çš„ã€‚åˆ°æ­¤ï¼Œæœ‰å…³execute()æ–¹æ³•çš„æºç è§£è¯»ï¼Œå°±å…ˆåˆ°è¿™é‡Œã€‚</p> <p>æ¥ç€æˆ‘ä»¬æ¥çœ‹å½“çº¿ç¨‹æ± å…³é—­æ—¶ä¼šåšä»€ä¹ˆäº‹æƒ…ï¼š</p> <h3 id="çº¿ç¨‹æ± å…³é—­"><a href="#çº¿ç¨‹æ± å…³é—­" class="header-anchor">#</a> çº¿ç¨‹æ± å…³é—­</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//æ™®é€šçš„shutdownä¼šç»§ç»­å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹æ‰§è¡Œå®Œæˆåå†å…³é—­çº¿ç¨‹æ± </span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
    mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      	<span class="token comment">//åˆ¤æ–­æ˜¯å¦æœ‰æƒé™ç»ˆæ­¢</span>
        <span class="token function">checkShutdownAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">//CASå°†çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€æ”¹ä¸ºSHUTDOWNçŠ¶æ€ï¼Œè¿˜ç®—æ¯”è¾ƒæ¸©æŸ”ï¼Œè¯¦ç»†è¿‡ç¨‹çœ‹ä¸‹é¢</span>
        <span class="token function">advanceRunState</span><span class="token punctuation">(</span><span class="token constant">SHUTDOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       	<span class="token comment">//è®©é—²ç€çš„çº¿ç¨‹ï¼ˆæ¯”å¦‚æ­£åœ¨ç­‰æ–°çš„ä»»åŠ¡ï¼‰ä¸­æ–­ï¼Œä½†æ˜¯å¹¶ä¸ä¼šå½±å“æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œè¯¦ç»†è¿‡ç¨‹è¯·çœ‹ä¸‹é¢</span>
        <span class="token function">interruptIdleWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">onShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ç»™ScheduledThreadPoolExecutoræä¾›çš„é’©å­æ–¹æ³•ï¼Œå°±æ˜¯ç­‰ScheduledThreadPoolExecutorå»å®ç°çš„ï¼Œå½“å‰ç±»æ²¡æœ‰å®ç°</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//æœ€åå°è¯•ç»ˆæ­¢çº¿ç¨‹æ± </span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">advanceRunState</span><span class="token punctuation">(</span><span class="token keyword">int</span> targetState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è·å–ctl</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> targetState<span class="token punctuation">)</span> <span class="token operator">||</span>    <span class="token comment">//æ˜¯å¦å¤§äºç­‰äºæŒ‡å®šçš„çŠ¶æ€</span>
            ctl<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token function">ctlOf</span><span class="token punctuation">(</span>targetState<span class="token punctuation">,</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//CASè®¾ç½®ctlçš„å€¼</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>   <span class="token comment">//ä»»æ„ä¸€ä¸ªæ¡ä»¶OKå°±å¯ä»¥ç»“æŸäº†</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">interruptIdleWorkers</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> onlyOne<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
    mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Worker</span> w <span class="token operator">:</span> workers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> t <span class="token operator">=</span> w<span class="token punctuation">.</span>thread<span class="token punctuation">;</span>    <span class="token comment">//æ‹¿åˆ°Workerä¸­çš„çº¿ç¨‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> w<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//å…ˆåˆ¤æ–­ä¸€ä¸‹çº¿ç¨‹æ˜¯ä¸æ˜¯æ²¡æœ‰è¢«ä¸­æ–­ç„¶åå°è¯•åŠ é”ï¼Œä½†æ˜¯é€šè¿‡å‰é¢çš„runWorker()æºä»£ç æˆ‘ä»¬å¾—çŸ¥ï¼Œå¼€å§‹ä¹‹åæ˜¯è®©WorkeråŠ äº†é”çš„ï¼Œæ‰€ä»¥å¦‚æœçº¿ç¨‹è¿˜åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œé‚£ä¹ˆè¿™é‡Œè‚¯å®šä¼šfalse</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    t<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¦‚æœèµ°åˆ°è¿™é‡Œï¼Œé‚£ä¹ˆè¯´æ˜çº¿ç¨‹è‚¯å®šæ˜¯ä¸€ä¸ªé—²ç€çš„çº¿ç¨‹ï¼Œç›´æ¥ç»™ä¸­æ–­å§</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//è§£é”</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>onlyOne<span class="token punctuation">)</span>   <span class="token comment">//å¦‚æœåªé’ˆå¯¹ä¸€ä¸ªWorkerï¼Œé‚£ä¹ˆå°±ç»“æŸå¾ªç¯</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>è€ŒshutdownNow()æ–¹æ³•ä¹Ÿå·®ä¸å¤šï¼Œä½†æ˜¯è¿™é‡Œä¼šæ›´ç›´æ¥ä¸€äº›ï¼š</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//shutdownNowå¼€å§‹åï¼Œä¸ä»…ä¸å…è®¸æ–°çš„ä»»åŠ¡åˆ°æ¥ï¼Œä¹Ÿä¸ä¼šå†æ‰§è¡Œç­‰å¾…é˜Ÿåˆ—çš„çº¿ç¨‹ï¼Œè€Œä¸”ä¼šç»ˆæ­¢æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> <span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> tasks<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
    mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">checkShutdownAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">//è¿™é‡Œå°±æ˜¯ç›´æ¥è®¾å®šä¸ºSTOPçŠ¶æ€äº†ï¼Œä¸å†åƒshutdowné‚£ä¹ˆæ¸©æŸ”</span>
        <span class="token function">advanceRunState</span><span class="token punctuation">(</span><span class="token constant">STOP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">//ç›´æ¥ä¸­æ–­æ‰€æœ‰å·¥ä½œçº¿ç¨‹ï¼Œè¯¦ç»†è¿‡ç¨‹çœ‹ä¸‹é¢</span>
        <span class="token function">interruptWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">//å–å‡ºä»å¤„äºé˜»å¡é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹</span>
        tasks <span class="token operator">=</span> <span class="token function">drainQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> tasks<span class="token punctuation">;</span>   <span class="token comment">//æœ€åè¿”å›è¿˜æ²¡å¼€å§‹çš„ä»»åŠ¡</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">interruptWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
    mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Worker</span> w <span class="token operator">:</span> workers<span class="token punctuation">)</span>   <span class="token comment">//éå†æ‰€æœ‰Worker</span>
            w<span class="token punctuation">.</span><span class="token function">interruptIfStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//æ— å·®åˆ«å¯¹å¾…ï¼Œä¸€å¾‹åŠ ä¸­æ–­æ ‡è®°</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>æœ€åçš„æœ€åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹tryTerminate()æ˜¯æ€ä¹ˆå®Œå®Œå…¨å…¨ç»ˆæ­¢æ‰ä¸€ä¸ªçº¿ç¨‹æ± çš„ï¼š</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">//æ— é™å¾ªç¯</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ä¸Šæ¥å…ˆè·å–ä¸€ä¸‹ctlå€¼</span>
      	<span class="token comment">//åªè¦æ˜¯æ­£åœ¨è¿è¡Œ æˆ–æ˜¯ çº¿ç¨‹æ± åŸºæœ¬ä¸Šå…³é—­äº† æˆ–æ˜¯ å¤„äºSHUTDOWNçŠ¶æ€ä¸”å·¥ä½œé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆè¿™æ—¶è¿˜ä¸èƒ½å…³é—­çº¿ç¨‹æ± ï¼Œè¿”å›</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token constant">TIDYING</span><span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span><span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
      
      	<span class="token comment">//èµ°åˆ°è¿™é‡Œï¼Œè¦ä¹ˆå¤„äºSHUTDOWNçŠ¶æ€ä¸”ç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºæˆ–æ˜¯STOPçŠ¶æ€</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å¦‚æœå·¥ä½œçº¿ç¨‹æ•°ä¸æ˜¯0ï¼Œè¿™é‡Œä¹Ÿä¼šä¸­æ–­ç©ºé—²çŠ¶æ€ä¸‹çš„çº¿ç¨‹</span>
            <span class="token function">interruptIdleWorkers</span><span class="token punctuation">(</span><span class="token constant">ONLY_ONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//è¿™é‡Œæœ€å¤šåªä¸­æ–­ä¸€ä¸ªç©ºé—²çº¿ç¨‹ï¼Œç„¶åè¿”å›</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      	<span class="token comment">//èµ°åˆ°è¿™é‡Œï¼Œå·¥ä½œçº¿ç¨‹ä¹Ÿä¸ºç©ºäº†ï¼Œå¯ä»¥ç»ˆæ­¢çº¿ç¨‹æ± äº†</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
        mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token function">ctlOf</span><span class="token punctuation">(</span><span class="token constant">TIDYING</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//å…ˆCASå°†çŠ¶æ€è®¾å®šä¸ºTIDYINGè¡¨ç¤ºåŸºæœ¬ç»ˆæ­¢ï¼Œæ­£åœ¨åšæœ€åçš„æ“ä½œ</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">terminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//ç»ˆæ­¢ï¼Œæš‚æ—¶æ²¡æœ‰å®ç°</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    ctl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">ctlOf</span><span class="token punctuation">(</span><span class="token constant">TERMINATED</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//æœ€åå°†çŠ¶æ€è®¾å®šä¸ºTERMINATEDï¼Œçº¿ç¨‹æ± ç»“æŸäº†å®ƒå¹´è½»çš„ç”Ÿå‘½</span>
                    termination<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¦‚æœæœ‰çº¿ç¨‹è°ƒç”¨äº†awaitTerminationæ–¹æ³•ï¼Œä¼šç­‰å¾…å½“å‰çº¿ç¨‹æ± ç»ˆæ­¢ï¼Œåˆ°è¿™é‡Œå·®ä¸å¤šå°±å¯ä»¥å”¤é†’äº†</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>   <span class="token comment">//ç»“æŸ</span>
            <span class="token punctuation">}</span>
          	<span class="token comment">//æ³¨æ„å¦‚æœCASå¤±è´¥ä¼šç›´æ¥è¿›ä¸‹ä¸€è½®å¾ªç¯é‡æ–°åˆ¤æ–­</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// else retry on failed CAS</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h3> <ul><li>è¿™ä¸€ç« èŠ‚å¹¶æ²¡æœ‰å®Œå…¨æŠŠçº¿ç¨‹æ± çš„æ‰€æœ‰çŸ¥è¯†ç‚¹éƒ½ä»‹ç»å®Œï¼Œå¦åˆ™ä¸€ç¯‡å†…å®¹ä¼šæœ‰äº›è‡ƒè‚¿ã€‚åœ¨è¿™ä¸€ç« èŠ‚æˆ‘ä»¬ä»æ‰‹å†™çº¿ç¨‹æ± å¼€å§‹ï¼Œé€æ­¥çš„åˆ†æè¿™äº›ä»£ç åœ¨Javaçš„çº¿ç¨‹æ± ä¸­æ˜¯å¦‚ä½•å®ç°çš„ï¼Œæ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹ä¹Ÿå‡ ä¹æ˜¯æˆ‘ä»¬ä»¥å‰ä»‹ç»è¿‡çš„å†…å®¹ï¼ŒåŒ…æ‹¬ï¼šé˜Ÿåˆ—ã€CASã€AQSã€é‡å…¥é”ã€ç‹¬å é”ç­‰å†…å®¹ã€‚æ‰€ä»¥è¿™äº›çŸ¥è¯†ä¹ŸåŸºæœ¬æ˜¯ç¯ç¯ç›¸æ‰£çš„ï¼Œæœ€å¥½æœ‰ä¸€äº›æ ¹åŸºå¦åˆ™ä¼šæœ‰äº›ä¸å¥½ç†è§£ã€‚</li> <li>é™¤äº†æœ¬ç« ä»‹ç»çš„ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰è®²åˆ°å››ç§çº¿ç¨‹æ± æ–¹æ³•çš„é€‰æ‹©å’Œä½¿ç”¨ã€ä»¥åŠåœ¨CPUå¯†é›†å‹ä»»åŠ¡ã€IO å¯†é›†å‹ä»»åŠ¡æ—¶è¯¥æ€ä¹ˆé…ç½®ã€‚å¦å¤–åœ¨Springä¸­ä¹Ÿæœ‰è‡ªå·±å®ç°çš„çº¿ç¨‹æ± æ–¹æ³•ã€‚è¿™äº›çŸ¥è¯†ç‚¹éƒ½éå¸¸è´´è¿‘å®é™…æ“ä½œã€‚</li> <li>å¥½äº†ï¼Œä»Šå¤©çš„å†…å®¹å…ˆæ‰¯åˆ°è¿™ï¼Œåç»­çš„å†…å®¹é™†ç»­å®Œå–„ã€‚å¦‚æœä»¥ä¸Šå†…å®¹æœ‰é”™å­—ã€æµç¨‹ç¼ºå¤±ã€æˆ–è€…ä¸å¥½ç†è§£ä»¥åŠæè¿°é”™è¯¯ï¼Œæ¬¢è¿ç•™è¨€ã€‚äº’ç›¸å­¦ä¹ ã€äº’ç›¸è¿›æ­¥ã€‚</li></ul> <hr> <hr> <h2 id="çº¿ç¨‹æ± çš„ä»‹ç»å’Œä½¿ç”¨-ä»¥åŠåŸºäºjvmtiè®¾è®¡éå…¥ä¾µç›‘æ§"><a href="#çº¿ç¨‹æ± çš„ä»‹ç»å’Œä½¿ç”¨-ä»¥åŠåŸºäºjvmtiè®¾è®¡éå…¥ä¾µç›‘æ§" class="header-anchor">#</a> çº¿ç¨‹æ± çš„ä»‹ç»å’Œä½¿ç”¨ï¼Œä»¥åŠåŸºäºjvmtiè®¾è®¡éå…¥ä¾µç›‘æ§</h2> <h3 id="å››ç§çº¿ç¨‹æ± ä½¿ç”¨ä»‹ç»"><a href="#å››ç§çº¿ç¨‹æ± ä½¿ç”¨ä»‹ç»" class="header-anchor">#</a> å››ç§çº¿ç¨‹æ± ä½¿ç”¨ä»‹ç»</h3> <p><code>Executors</code>æ˜¯åˆ›å»ºçº¿ç¨‹æ± çš„å·¥å…·ç±»ï¼Œæ¯”è¾ƒå…¸å‹å¸¸è§çš„å››ç§çº¿ç¨‹æ± åŒ…æ‹¬ï¼š<code>newFixedThreadPool</code>ã€<code>newSingleThreadExecutor</code>ã€<code>newCachedThreadPool</code>ã€<code>newScheduledThreadPool</code>ã€‚æ¯ä¸€ç§éƒ½æœ‰è‡ªå·±ç‰¹å®šçš„å…¸å‹ä¾‹å­ï¼Œå¯ä»¥æŒ‰ç…§æ¯ç§çš„ç‰¹æ€§ç”¨åœ¨ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼Œä¹Ÿå¯ä»¥åšä¸ºå‚ç…§ç²¾ç»†åŒ–åˆ›å»ºçº¿ç¨‹æ± ã€‚</p> <h4 id="newfixedthreadpool"><a href="#newfixedthreadpool" class="header-anchor">#</a> newFixedThreadPool</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> groupId <span class="token operator">=</span> i<span class="token punctuation">;</span>
        executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ç¬¬ {} ç»„ä»»åŠ¡ï¼Œç¬¬ {} æ¬¡æ‰§è¡Œå®Œæˆ&quot;</span><span class="token punctuation">,</span> groupId<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// æµ‹è¯•ç»“æœ</span>
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">24.628</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">24.628</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">24.628</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">25.633</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">25.633</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">25.633</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">26.633</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">26.633</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">26.633</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">27.634</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">27.634</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">27.634</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">28.635</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">29.635</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">30.635</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">31.636</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>å›¾è§£
<img src="/java/thread/interview-22-1.png" alt="pic"></p> <ul><li>ä»£ç ï¼š<code>new ThreadPoolExecutor(nThreads, nThreads, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;Runnable&gt;())</code></li> <li>ä»‹ç»ï¼šåˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°å¯é‡å¤ä½¿ç”¨çš„çº¿ç¨‹æ± ï¼Œä»¥ LinkedBlockingQueue æ— ç•Œé˜»å¡é˜Ÿåˆ—å­˜æ”¾ç­‰å¾…çº¿ç¨‹ã€‚</li> <li>é£é™©ï¼šéšç€çº¿ç¨‹ä»»åŠ¡ä¸èƒ½è¢«æ‰§è¡Œçš„çš„æ— é™å †ç§¯ï¼Œå¯èƒ½ä¼šå¯¼è‡´OOMã€‚</li></ul> <hr> <h4 id="newsinglethreadexecutor"><a href="#newsinglethreadexecutor" class="header-anchor">#</a> newSingleThreadExecutor</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> groupId <span class="token operator">=</span> i<span class="token punctuation">;</span>
        executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ç¬¬ {} ç»„ä»»åŠ¡ï¼Œç¬¬ {} æ¬¡æ‰§è¡Œå®Œæˆ&quot;</span><span class="token punctuation">,</span> groupId<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// æµ‹è¯•ç»“æœ</span>
<span class="token number">23</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">15.066</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">16.069</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">17.070</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">18.070</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">19.071</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">280.071</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">281.072</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">282.072</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">283.073</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">284.074</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">285.074</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">286.075</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">287.075</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">288.075</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">289.076</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">30.076</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>å›¾è§£
<img src="/java/thread/interview-22-2.png" alt="pic"></p> <ul><li>ä»£ç ï¼š<code>new ThreadPoolExecutor(1, 1, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;Runnable&gt;())</code></li> <li>ä»‹ç»ï¼šåªåˆ›å»ºä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹ä»»åŠ¡çš„çº¿ç¨‹æ± ï¼Œå¦‚æœå‡ºç°æ„å¤–ç»ˆæ­¢åˆ™å†åˆ›å»ºä¸€ä¸ªã€‚</li> <li>é£é™©ï¼šåŒæ ·è¿™ä¹Ÿæ˜¯ä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—å­˜æ”¾å¾…æ‰§è¡Œçº¿ç¨‹ï¼Œæ— é™å †ç§¯ä¸‹ä¼šå‡ºç°OOMã€‚</li></ul> <hr> <h4 id="newcachedthreadpool"><a href="#newcachedthreadpool" class="header-anchor">#</a> newCachedThreadPool</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> groupId <span class="token operator">=</span> i<span class="token punctuation">;</span>
        executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ç¬¬ {} ç»„ä»»åŠ¡ï¼Œç¬¬ {} æ¬¡æ‰§è¡Œå®Œæˆ&quot;</span><span class="token punctuation">,</span> groupId<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// æµ‹è¯•ç»“æœ</span>
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">59.818</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">59.818</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">59.818</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">59.818</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">00.823</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">00.823</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">00.823</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">00.823</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">01.823</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">01.823</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">01.824</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">01.824</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">02.824</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">02.824</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">02.825</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">02.825</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>å›¾è§£
<img src="/java/thread/interview-22-3.png" alt="pic"></p> <ul><li>ä»£ç ï¼š<code>new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60L, TimeUnit.SECONDS, new SynchronousQueue&lt;Runnable&gt;())</code></li> <li>ä»‹ç»ï¼šé¦–å…ˆ SynchronousQueue æ˜¯ä¸€ä¸ªç”Ÿäº§æ¶ˆè´¹æ¨¡å¼çš„é˜»å¡ä»»åŠ¡é˜Ÿåˆ—ï¼Œåªè¦æœ‰ä»»åŠ¡å°±éœ€è¦æœ‰çº¿ç¨‹æ‰§è¡Œï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¯ä»¥é‡å¤ä½¿ç”¨ã€‚</li> <li>é£é™©ï¼šå¦‚æœçº¿ç¨‹ä»»åŠ¡æ¯”è¾ƒè€—æ—¶ï¼Œåˆå¤§é‡åˆ›å»ºï¼Œä¼šå¯¼è‡´OOM</li></ul> <hr> <h4 id="newscheduledthreadpool"><a href="#newscheduledthreadpool" class="header-anchor">#</a> newScheduledThreadPool</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ScheduledExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    executorService<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;3ç§’åå¼€å§‹æ‰§è¡Œ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    executorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;3ç§’åå¼€å§‹æ‰§è¡Œï¼Œä»¥åæ¯2ç§’æ‰§è¡Œä¸€æ¬¡&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    executorService<span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;3ç§’åå¼€å§‹æ‰§è¡Œï¼Œåç»­å»¶è¿Ÿ2ç§’&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// æµ‹è¯•ç»“æœ</span>
<span class="token number">23</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">32.442</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newScheduledThreadPool</span> <span class="token operator">-</span> <span class="token number">3</span>ç§’åå¼€å§‹æ‰§è¡Œ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">32.444</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newScheduledThreadPool</span> <span class="token operator">-</span> <span class="token number">3</span>ç§’åå¼€å§‹æ‰§è¡Œï¼Œä»¥åæ¯<span class="token number">2</span>ç§’æ‰§è¡Œä¸€æ¬¡
<span class="token number">23</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">32.444</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newScheduledThreadPool</span> <span class="token operator">-</span> <span class="token number">3</span>ç§’åå¼€å§‹æ‰§è¡Œï¼Œåç»­å»¶è¿Ÿ<span class="token number">2</span>ç§’
<span class="token number">23</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">34.441</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newScheduledThreadPool</span> <span class="token operator">-</span> <span class="token number">3</span>ç§’åå¼€å§‹æ‰§è¡Œï¼Œä»¥åæ¯<span class="token number">2</span>ç§’æ‰§è¡Œä¸€æ¬¡
<span class="token number">23</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">34.445</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newScheduledThreadPool</span> <span class="token operator">-</span> <span class="token number">3</span>ç§’åå¼€å§‹æ‰§è¡Œï¼Œåç»­å»¶è¿Ÿ<span class="token number">2</span>ç§’
<span class="token number">23</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">36.440</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newScheduledThreadPool</span> <span class="token operator">-</span> <span class="token number">3</span>ç§’åå¼€å§‹æ‰§è¡Œï¼Œä»¥åæ¯<span class="token number">2</span>ç§’æ‰§è¡Œä¸€æ¬¡
<span class="token number">23</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">36.445</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newScheduledThreadPool</span> <span class="token operator">-</span> <span class="token number">3</span>ç§’åå¼€å§‹æ‰§è¡Œï¼Œåç»­å»¶è¿Ÿ<span class="token number">2</span>ç§’
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>å›¾è§£
<img src="/java/thread/interview-22-4.png" alt="pic"></p> <ul><li>ä»£ç ï¼š<code>public ScheduledThreadPoolExecutor(int corePoolSize) { super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS, new ScheduledThreadPoolExecutor.DelayedWorkQueue()); }</code></li> <li>ä»‹ç»ï¼šè¿™å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„çº¿ç¨‹æ± äº†ï¼Œå®ƒå¯ä»¥å»¶è¿Ÿå®šæ—¶æ‰§è¡Œï¼Œæœ‰ç‚¹åƒæˆ‘ä»¬çš„å®šæ—¶ä»»åŠ¡ã€‚åŒæ ·å®ƒä¹Ÿæ˜¯ä¸€ä¸ªæ— é™å¤§å°çš„çº¿ç¨‹æ±  Integer.MAX_VALUEã€‚å®ƒæä¾›çš„è°ƒç”¨æ–¹æ³•æ¯”è¾ƒå¤šï¼ŒåŒ…æ‹¬ï¼šscheduleAtFixedRateã€scheduleWithFixedDelayï¼Œå¯ä»¥æŒ‰éœ€é€‰æ‹©å»¶è¿Ÿæ‰§è¡Œæ–¹å¼ã€‚</li> <li>é£é™©ï¼šåŒæ ·ç”±äºè¿™æ˜¯ä¸€ç»„æ— é™å®¹é‡çš„çº¿ç¨‹æ± ï¼Œæ‰€ä»¥ä¾æ—§æœ‰OOMé£é™©ã€‚</li></ul> <hr> <h3 id="çº¿ç¨‹æ± ä½¿ç”¨åœºæ™¯è¯´æ˜"><a href="#çº¿ç¨‹æ± ä½¿ç”¨åœºæ™¯è¯´æ˜" class="header-anchor">#</a> çº¿ç¨‹æ± ä½¿ç”¨åœºæ™¯è¯´æ˜</h3> <p>ä»€ä¹ˆæ—¶å€™ä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿ</p> <p>è¯´ç®€å•æ˜¯å½“ä¸ºäº†ç»™è€æ¿çœé’±çš„æ—¶å€™ï¼Œå› ä¸ºä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥é™ä½æœåŠ¡å™¨èµ„æºçš„æŠ•å…¥ï¼Œè®©æ¯å°æœºå™¨å°½å¯èƒ½æ›´å¤§é™åº¦çš„ä½¿ç”¨CPUã€‚</p> <p>ğŸ˜„é‚£ä½ è¿™ä¹ˆè¯´è‚¯å®šæ²¡åŠæ³•å‡èŒåŠ è–ªäº†ï¼</p> <p>æ‰€ä»¥å¦‚æœè¯´çš„é«˜å¤§ä¸Šä¸€ç‚¹ï¼Œé‚£ä¹ˆæ˜¯åœ¨ç¬¦åˆç§‘ç‰¹å°”æ³•åˆ™ (opens new window)å’Œé˜¿å§†è¾¾å°”å®šå¾‹  (opens new window)çš„æƒ…å†µä¸‹ï¼Œå¼•å…¥çº¿ç¨‹æ± çš„ä½¿ç”¨æœ€ä¸ºåˆç†ã€‚å•¥æ„æ€å‘¢ï¼Œè¿˜å¾—ç®€å•è¯´ï¼</p> <p>å‡å¦‚ï¼šæˆ‘ä»¬æœ‰ä¸€å¥—ç”µå•†æœåŠ¡ï¼Œç”¨æˆ·æµè§ˆå•†å“çš„å¹¶å‘è®¿é—®é€Ÿç‡æ˜¯ï¼š1000å®¢æˆ·/æ¯åˆ†é’Ÿï¼Œå¹³å‡æ¯ä¸ªå®¢æˆ·åœ¨æœåŠ¡å™¨ä¸Šçš„è€—æ—¶0.5åˆ†é’Ÿã€‚æ ¹æ®åˆ©ç‰¹å°”æ³•åˆ™ï¼Œåœ¨ä»»ä½•æ—¶åˆ»ï¼ŒæœåŠ¡ç«¯éƒ½æ‰¿æ‹…ç€1000Ã—0.5=500ä¸ªå®¢æˆ·çš„ä¸šåŠ¡å¤„ç†é‡ã€‚è¿‡æ®µæ—¶é—´å¤§ä¿ƒäº†ï¼Œå¹¶å‘è®¿é—®çš„ç”¨æˆ·æ‰©äº†ä¸€å€2000å®¢æˆ·äº†ï¼Œé‚£æ€ä¹ˆä¿éšœæœåŠ¡æ€§èƒ½å‘¢ï¼Ÿ</p> <ol><li>æé«˜æœåŠ¡å™¨å¹¶å‘å¤„ç†çš„ä¸šåŠ¡é‡ï¼Œå³æé«˜åˆ°2000Ã—0.5=1000</li> <li>å‡å°‘æœåŠ¡å™¨å¹³å‡å¤„ç†å®¢æˆ·è¯·æ±‚çš„æ—¶é—´ï¼Œå³å‡å°‘åˆ°ï¼š2000Ã—0.25=500
æ‰€ä»¥ï¼šåœ¨æœ‰äº›åœºæ™¯ä¸‹ä¼šæŠŠä¸²è¡Œçš„è¯·æ±‚æ¥å£ï¼Œå‹ç¼©æˆå¹¶è¡Œæ‰§è¡Œï¼Œå¦‚ä¸‹å›¾
<img src="/java/thread/interview-22-5.png" alt="pic">
ä½†æ˜¯ï¼Œçº¿ç¨‹æ± çš„ä½¿ç”¨ä¼šéšç€ä¸šåŠ¡åœºæ™¯å˜åŒ–è€Œä¸åŒï¼Œå¦‚æœä½ çš„ä¸šåŠ¡éœ€è¦å¤§é‡çš„ä½¿ç”¨çº¿ç¨‹æ± ï¼Œå¹¶éå¸¸ä¾èµ–çº¿ç¨‹æ± ï¼Œé‚£ä¹ˆå°±ä¸å¯èƒ½ç”¨ Executors å·¥å…·ç±»ä¸­æä¾›çš„æ–¹æ³•ã€‚å› ä¸ºè¿™äº›çº¿ç¨‹æ± çš„åˆ›å»ºéƒ½ä¸å¤Ÿç²¾ç»†åŒ–ï¼Œä¹Ÿéå¸¸å®¹æ˜“é€ æˆOOMé£é™©ï¼Œè€Œä¸”éšç€ä¸šåŠ¡åœºæ™¯é€»è¾‘ä¸åŒï¼Œä¼šæœ‰IOå¯†é›†å‹å’ŒCPUå¯†é›†å‹ã€‚</li></ol> <p>æœ€ç»ˆï¼Œå¤§å®¶ä½¿ç”¨çš„çº¿ç¨‹æ± éƒ½æ˜¯ä½¿ç”¨ new ThreadPoolExecutor() åˆ›å»ºçš„ï¼Œå½“ç„¶ä¹Ÿæœ‰åŸºäºSpringçš„çº¿ç¨‹æ± é…ç½® org.springframework.scheduling.concurrent.ThreadPoolTaskExecutorã€‚</p> <p>å¯ä½ æƒ³è¿‡å—ï¼ŒåŒæ ·ä¸€ä¸ªæ¥å£åœ¨æœ‰æ´»åŠ¨æ—¶å€™æ€ä¹ˆåŠã€æœ‰å¤§ä¿ƒæ—¶å€™æ€ä¹ˆåŠï¼Œå¯èƒ½ä½ å½“æ—¶è®¾ç½®çš„çº¿ç¨‹æ± æ˜¯åˆç†çš„ï¼Œä½†æ˜¯ä¸€åˆ°æµé‡éå¸¸å¤§çš„æ—¶å€™å°±å¾ˆä¸é€‚åˆäº†ï¼Œæ‰€ä»¥å¦‚æœèƒ½åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å°±éå¸¸æœ‰å¿…è¦äº†ã€‚è€Œä¸”ä½¿ç”¨ new ThreadPoolExecutor() æ–¹å¼åˆ›å»ºçš„çº¿ç¨‹æ± æ˜¯å¯ä»¥é€šè¿‡æä¾›çš„ set æ–¹æ³•è¿›è¡ŒåŠ¨æ€è°ƒæ•´çš„ã€‚æœ‰äº†è¿™ä¸ªåŠ¨æ€è°ƒæ•´çš„æ–¹æ³•åï¼Œå°±å¯ä»¥æŠŠçº¿ç¨‹æ± åŒ…è£…èµ·æ¥ï¼Œåœ¨é…åˆåŠ¨æ€è°ƒæ•´çš„é¡µé¢ï¼ŒåŠ¨æ€æ›´æ–°çº¿ç¨‹æ± å‚æ•°ï¼Œå°±å¯ä»¥éå¸¸æ–¹ä¾¿çš„è°ƒæ•´çº¿ç¨‹æ± äº†ã€‚</p> <hr> <h3 id="è·å–çº¿ç¨‹æ± ç›‘æ§ä¿¡æ¯"><a href="#è·å–çº¿ç¨‹æ± ç›‘æ§ä¿¡æ¯" class="header-anchor">#</a> è·å–çº¿ç¨‹æ± ç›‘æ§ä¿¡æ¯</h3> <p>å¯ç›‘æ§å†…å®¹</p> <table><thead><tr><th>æ–¹æ³•</th> <th style="text-align:center;">å«ä¹‰</th></tr></thead> <tbody><tr><td>getActiveCount()</td> <td style="text-align:center;">çº¿ç¨‹æ± ä¸­æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ•°é‡</td></tr> <tr><td>getCompletedTaskCount()</td> <td style="text-align:center;">çº¿ç¨‹æ± å·²å®Œæˆçš„ä»»åŠ¡æ•°é‡ï¼Œè¯¥å€¼å°äºç­‰äºtaskCount</td></tr> <tr><td>getCorePoolSize()</td> <td style="text-align:center;">çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡</td></tr> <tr><td>getLargestPoolSize()</td> <td style="text-align:center;">çº¿ç¨‹æ± æ›¾ç»åˆ›å»ºè¿‡çš„æœ€å¤§çº¿ç¨‹æ•°é‡ã€‚é€šè¿‡è¿™ä¸ªæ•°æ®å¯ä»¥çŸ¥é“çº¿ç¨‹æ± æ˜¯å¦æ»¡è¿‡ï¼Œä¹Ÿå°±æ˜¯è¾¾åˆ°äº†maximumPoolSize</td></tr> <tr><td>getMaximumPoolSize()</td> <td style="text-align:center;">çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°é‡</td></tr> <tr><td>getPoolSize()</td> <td style="text-align:center;">çº¿ç¨‹æ± å½“å‰çš„çº¿ç¨‹æ•°é‡</td></tr> <tr><td>getTaskCount()</td> <td style="text-align:center;">çº¿ç¨‹æ± å·²ç»æ‰§è¡Œçš„å’Œæœªæ‰§è¡Œçš„ä»»åŠ¡æ€»æ•°</td></tr></tbody></table> <h4 id="é‡å†™çº¿ç¨‹æ± æ–¹å¼ç›‘æ§"><a href="#é‡å†™çº¿ç¨‹æ± æ–¹å¼ç›‘æ§" class="header-anchor">#</a> é‡å†™çº¿ç¨‹æ± æ–¹å¼ç›‘æ§</h4> <p>å¦‚æœæˆ‘ä»¬æƒ³ç›‘æ§ä¸€ä¸ªçº¿ç¨‹æ± çš„æ–¹æ³•æ‰§è¡ŒåŠ¨ä½œï¼Œæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ç»§æ‰¿è¿™ä¸ªç±»ï¼Œé‡å†™æ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­æ·»åŠ åŠ¨ä½œæ”¶é›†ä¿¡æ¯ã€‚
ä¼ªä»£ç </p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolMonitor</span> <span class="token keyword">extends</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç»Ÿè®¡å·²æ‰§è¡Œä»»åŠ¡ã€æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€æœªæ‰§è¡Œä»»åŠ¡æ•°é‡</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> <span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç»Ÿè®¡å·²æ‰§è¡Œä»»åŠ¡ã€æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€æœªæ‰§è¡Œä»»åŠ¡æ•°é‡</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">beforeExecute</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è®°å½•å¼€å§‹æ—¶é—´</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">afterExecute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è®°å½•å®Œæˆè€—æ—¶</span>
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><hr> <h4 id="åŸºäºjvmtiæ–¹å¼ç›‘æ§"><a href="#åŸºäºjvmtiæ–¹å¼ç›‘æ§" class="header-anchor">#</a> åŸºäºJVMTIæ–¹å¼ç›‘æ§</h4> <p>è¿™å—æ˜¯ç›‘æ§çš„é‡ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å¤ªå¯èƒ½è®©æ¯ä¸€ä¸ªéœ€è¦ç›‘æ§çš„çº¿ç¨‹æ± éƒ½æ¥é‡å†™çš„æ–¹å¼è®°å½•ï¼Œè¿™æ ·çš„æ”¹é€ æˆæœ¬å¤ªé«˜äº†ã€‚</p> <p>é‚£ä¹ˆé™¤äº†è¿™ä¸ªç¬¨æ–¹æ³•å¤–ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨åŸºäºJVMTIçš„æ–¹å¼ï¼Œè¿›è¡Œå¼€å‘ç›‘æ§ç»„ä»¶ã€‚</p> <p>JVMTIï¼šJVMTI(JVM Tool Interface)ä½äºjpdaæœ€åº•å±‚ï¼Œæ˜¯Javaè™šæ‹Ÿæœºæ‰€æä¾›çš„nativeç¼–ç¨‹æ¥å£ã€‚JVMTIå¯ä»¥æä¾›æ€§èƒ½åˆ†æã€debugã€å†…å­˜ç®¡ç†ã€çº¿ç¨‹åˆ†æç­‰åŠŸèƒ½ã€‚</p> <p>åŸºäºjvmtiæä¾›çš„æ¥å£æœåŠ¡ï¼Œè¿ç”¨C++ä»£ç (win32-add_library)åœ¨Agent_OnLoadé‡Œå¼€å‘ç›‘æ§æœåŠ¡ï¼Œå¹¶ç”Ÿæˆdllæ–‡ä»¶ã€‚å¼€å‘å®Œæˆååœ¨javaä»£ç ä¸­åŠ å…¥agentpathï¼Œè¿™æ ·å°±å¯ä»¥ç›‘æ§åˆ°æˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯å†…å®¹ã€‚
<a href="http://s.xiaoyuan.space/30yVRl" target="_blank" rel="noopener noreferrer">è¿™ä¸ªå¤ªé«˜çº§äº†ï¼Œæš‚æ—¶æ²¡å­¦æ˜ç™½ï¼Œè¯¦æƒ…ç‚¹æ­¤çœ‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <hr> <h4 id="åŸºäºä¸­é—´ä»¶çš„ç›‘æ§"><a href="#åŸºäºä¸­é—´ä»¶çš„ç›‘æ§" class="header-anchor">#</a> åŸºäºä¸­é—´ä»¶çš„ç›‘æ§</h4> <p>é©¬å“¥çš„hippo4j å¼€æºç»„ä»¶ï¼Œå¯ä»¥ç”¨äºå­¦ä¹ 
â— GitHubï¼šhttps://github.com/opengoofy/hippo4j
â— Giteeï¼šhttps://gitee.com/opengoofy/hippo4j</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/29/2024, 3:15:50 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/java/thread.html" class="prev">
        Thread
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.43c37fe5.js" defer></script><script src="/assets/js/2.d4767806.js" defer></script><script src="/assets/js/1.98e67d61.js" defer></script><script src="/assets/js/36.c2ff92ef.js" defer></script>
  </body>
</html>
